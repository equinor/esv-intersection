import{D as it,Y as q,R as X,W as ct,a2 as rt,a1 as tt,E as ot,N as _t,O as At,ac as Y,ad as dt,ae as ut,af as N,ag as G,ah as ft,ai as st,aj as vt,ak as K,Q as Mt}from"./elements-bFXFHGGJ.js";import{C as pt}from"./CanvasPool-DMzpdoSh.js";import"./preload-helper-Dp1pzeXC.js";import"./_commonjsHelpers-CqkleIqs.js";/**
 * tiny-lru
 *
 * @copyright 2026 Jason Mulligan <jason.mulligan@avoidwork.com>
 * @license BSD-3-Clause
 * @version 11.4.7
 */class Et{constructor(t=0,e=0,i=!1){this.first=null,this.items=Object.create(null),this.last=null,this.max=t,this.resetTtl=i,this.size=0,this.ttl=e}clear(){return this.first=null,this.items=Object.create(null),this.last=null,this.size=0,this}delete(t){if(this.has(t)){const e=this.items[t];delete this.items[t],this.size--,e.prev!==null&&(e.prev.next=e.next),e.next!==null&&(e.next.prev=e.prev),this.first===e&&(this.first=e.next),this.last===e&&(this.last=e.prev)}return this}entries(t=this.keys()){const e=new Array(t.length);for(let i=0;i<t.length;i++){const s=t[i];e[i]=[s,this.get(s)]}return e}evict(t=!1){if(t||this.size>0){const e=this.first;delete this.items[e.key],--this.size===0?(this.first=null,this.last=null):(this.first=e.next,this.first.prev=null)}return this}expiresAt(t){let e;return this.has(t)&&(e=this.items[t].expiry),e}get(t){const e=this.items[t];if(e!==void 0){if(this.ttl>0&&e.expiry<=Date.now()){this.delete(t);return}return this.moveToEnd(e),e.value}}has(t){return t in this.items}moveToEnd(t){this.last!==t&&(t.prev!==null&&(t.prev.next=t.next),t.next!==null&&(t.next.prev=t.prev),this.first===t&&(this.first=t.next),t.prev=this.last,t.next=null,this.last!==null&&(this.last.next=t),this.last=t,this.first===null&&(this.first=t))}keys(){const t=new Array(this.size);let e=this.first,i=0;for(;e!==null;)t[i++]=e.key,e=e.next;return t}setWithEvicted(t,e,i=this.resetTtl){let s=null;if(this.has(t))this.set(t,e,!0,i);else{this.max>0&&this.size===this.max&&(s={...this.first},this.evict(!0));let n=this.items[t]={expiry:this.ttl>0?Date.now()+this.ttl:this.ttl,key:t,prev:this.last,next:null,value:e};++this.size===1?this.first=n:this.last.next=n,this.last=n}return s}set(t,e,i=!1,s=this.resetTtl){let n=this.items[t];return i||n!==void 0?(n.value=e,i===!1&&s&&(n.expiry=this.ttl>0?Date.now()+this.ttl:this.ttl),this.moveToEnd(n)):(this.max>0&&this.size===this.max&&this.evict(!0),n=this.items[t]={expiry:this.ttl>0?Date.now()+this.ttl:this.ttl,key:t,prev:this.last,next:null,value:e},++this.size===1?this.first=n:this.last.next=n,this.last=n),this}values(t=this.keys()){const e=new Array(t.length);for(let i=0;i<t.length;i++)e[i]=this.get(t[i]);return e}}function yt(r=1e3,t=0,e=!1){if(isNaN(r)||r<0)throw new TypeError("Invalid max value");if(isNaN(t)||t<0)throw new TypeError("Invalid ttl value");if(typeof e!="boolean")throw new TypeError("Invalid resetTtl value");return new Et(r,t,e)}function Wt(r){return!!r.tagStyles&&Object.keys(r.tagStyles).length>0}function kt(r){return r.includes("<")}function Pt(r,t){return r.clone().assign(t)}function It(r,t){const e=[],i=t.tagStyles;if(!Wt(t)||!kt(r))return e.push({text:r,style:t}),e;const s=[t],n=[];let o="",a=0;for(;a<r.length;){const h=r[a];if(h==="<"){const l=r.indexOf(">",a);if(l===-1){o+=h,a++;continue}const c=r.slice(a+1,l);if(c.startsWith("/")){const d=c.slice(1).trim();if(n.length>0&&n[n.length-1]===d){o.length>0&&(e.push({text:o,style:s[s.length-1]}),o=""),s.pop(),n.pop(),a=l+1;continue}else{o+=r.slice(a,l+1),a=l+1;continue}}else{const d=c.trim();if(i[d]){o.length>0&&(e.push({text:o,style:s[s.length-1]}),o="");const S=s[s.length-1],y=Pt(S,i[d]);s.push(y),n.push(d),a=l+1;continue}else{o+=r.slice(a,l+1),a=l+1;continue}}}else o+=h,a++}return o.length>0&&e.push({text:o,style:s[s.length-1]}),e}const Ht=[10,13],Ot=new Set(Ht),Rt=[9,32,8192,8193,8194,8195,8196,8197,8198,8200,8201,8202,8287,12288],jt=new Set(Rt),Nt=/(\r\n|\r|\n)/,Gt=/(?:\r\n|\r|\n)/;function at(r){return typeof r!="string"?!1:Ot.has(r.charCodeAt(0))}function H(r,t){return typeof r!="string"?!1:jt.has(r.charCodeAt(0))}function Ft(r){return r==="normal"||r==="pre-line"}function Ct(r){return r==="normal"}function j(r){if(typeof r!="string")return"";let t=r.length-1;for(;t>=0&&H(r[t]);)t--;return t<r.length-1?r.slice(0,t+1):r}function Tt(r){const t=[],e=[];if(typeof r!="string")return t;for(let i=0;i<r.length;i++){const s=r[i],n=r[i+1];if(H(s)||at(s)){e.length>0&&(t.push(e.join("")),e.length=0),s==="\r"&&n===`
`?(t.push(`\r
`),i++):t.push(s);continue}e.push(s)}return e.length>0&&t.push(e.join("")),t}function Bt(r,t,e,i){const s=e(r),n=[];for(let o=0;o<s.length;o++){let a=s[o],h=a,l=1;for(;s[o+l];){const c=s[o+l];if(!i(h,c,r,o,t))a+=c,h=c,l++;else break}o+=l-1,n.push(a)}return n}const $t=/\r\n|\r|\n/g;function Dt(r,t,e,i,s,n,o,a){var b;const h=It(r,t);if(Ct(t.whiteSpace))for(let L=0;L<h.length;L++){const A=h[L];h[L]={text:A.text.replace($t," "),style:A.style}}const c=[];let d=[];for(const L of h){const A=L.text.split(Nt);for(let P=0;P<A.length;P++){const M=A[P];M===`\r
`||M==="\r"||M===`
`?(c.push(d),d=[]):M.length>0&&d.push({text:M,style:L.style})}}(d.length>0||c.length===0)&&c.push(d);const S=e?Kt(c,t,i,s,o,a):c,y=[],T=[],W=[],C=[],m=[];let u=0;const x=t._fontString,g=n(x);g.fontSize===0&&(g.fontSize=t.fontSize,g.ascent=t.fontSize);let k="",p=!!t.dropShadow;for(const L of S){let A=0,P=g.ascent,M=g.descent,E="";for(const R of L){const D=R.style._fontString,J=n(D);D!==k&&(i.font=D,k=D);const U=s(R.text,R.style.letterSpacing,i);A+=U,P=Math.max(P,J.ascent),M=Math.max(M,J.descent),E+=R.text,!p&&R.style.dropShadow&&(p=!0)}L.length===0&&(P=g.ascent,M=g.descent),y.push(A),T.push(P),W.push(M),m.push(E);const I=t.lineHeight||P+M;C.push(I+t.leading),u=Math.max(u,A)}const _=((b=t._stroke)==null?void 0:b.width)||0,O=(e&&t.align!=="left"&&t.align!=="justify"?Math.max(u,t.wordWrapWidth):u)+_+(t.dropShadow?t.dropShadow.distance:0);let v=0;for(let L=0;L<C.length;L++)v+=C[L];v=Math.max(v,C[0]+_);const F=v+(t.dropShadow?t.dropShadow.distance:0),z=t.lineHeight||g.fontSize;return{width:O,height:F,lines:m,lineWidths:y,lineHeight:z+t.leading,maxLineWidth:u,fontProperties:g,runsByLine:S,lineAscents:T,lineDescents:W,lineHeights:C,hasDropShadow:p}}function Kt(r,t,e,i,s,n){var C;const{letterSpacing:o,whiteSpace:a,wordWrapWidth:h,breakWords:l}=t,c=Ft(a),d=h+o,S={};let y="";const T=(m,u)=>{const x=`${m}|${u.styleKey}`;let g=S[x];if(g===void 0){const k=u._fontString;k!==y&&(e.font=k,y=k),g=i(m,u.letterSpacing,e)+u.letterSpacing,S[x]=g}return g},W=[];for(const m of r){const u=Vt(m),x=W.length,g=F=>{let z=0,b=F;do{const{token:L,style:A}=u[b];z+=T(L,A),b++}while(b<u.length&&u[b].continuesFromPrevious);return z},k=F=>{const z=[];let b=F;do z.push({token:u[b].token,style:u[b].style}),b++;while(b<u.length&&u[b].continuesFromPrevious);return z};let p=[],_=0,B=!c,w=null;const O=()=>{w&&w.text.length>0&&p.push(w),w=null},v=()=>{if(O(),p.length>0){const F=p[p.length-1];F.text=j(F.text),F.text.length===0&&p.pop()}W.push(p),p=[],_=0,B=!1};for(let F=0;F<u.length;F++){const{token:z,style:b,continuesFromPrevious:L}=u[F],A=T(z,b);if(c){const E=H(z),I=(w==null?void 0:w.text[w.text.length-1])??((C=p[p.length-1])==null?void 0:C.text.slice(-1))??"",R=I?H(I):!1;if(E&&R)continue}const P=!L,M=P?g(F):A;if(M>d&&P)if(_>0&&v(),l){const E=k(F);for(let I=0;I<E.length;I++){const R=E[I].token,D=E[I].style,J=Bt(R,l,n,s);for(const U of J){const lt=T(U,D);lt+_>d&&v(),!w||w.style!==D?(O(),w={text:U,style:D}):w.text+=U,_+=lt}}F+=E.length-1}else{const E=k(F);O(),W.push(E.map(I=>({text:I.token,style:I.style}))),B=!1,F+=E.length-1}else if(M+_>d&&P){if(H(z)){B=!1;continue}v(),w={text:z,style:b},_=A}else if(L&&!l)!w||w.style!==b?(O(),w={text:z,style:b}):w.text+=z,_+=A;else{const E=H(z);if(_===0&&E&&!B)continue;!w||w.style!==b?(O(),w={text:z,style:b}):w.text+=z,_+=A}}if(O(),p.length>0){const F=p[p.length-1];F.text=j(F.text),F.text.length===0&&p.pop()}(p.length>0||W.length===x)&&W.push(p)}return W}function Vt(r){const t=[];let e=!1;for(const i of r){const s=Tt(i.text);let n=!0;for(const o of s){const a=H(o)||at(o),h=n&&e&&!a;t.push({token:o,style:i.style,continuesFromPrevious:h}),e=!a,n=!1}}return t}const Yt={willReadFrequently:!0};function gt(r,t,e,i,s){let n=e[r];return typeof n!="number"&&(n=s(r,t,i)+t,e[r]=n),n}function Xt(r,t,e,i,s,n,o){const a=e.getContext("2d",Yt);a.font=t._fontString;let h=0,l="";const c=[],d=Object.create(null),{letterSpacing:S,whiteSpace:y}=t,T=Ft(y),W=Ct(y);let C=!T;const m=t.wordWrapWidth+S,u=Tt(r);for(let g=0;g<u.length;g++){let k=u[g];if(at(k)){if(!W){c.push(j(l)),C=!T,l="",h=0;continue}k=" "}if(T){const _=H(k),B=H(l[l.length-1]);if(_&&B)continue}const p=gt(k,S,d,a,i);if(p>m)if(l!==""&&(c.push(j(l)),l="",h=0),s(k,t.breakWords)){const _=Bt(k,t.breakWords,o,n);for(const B of _){const w=gt(B,S,d,a,i);w+h>m&&(c.push(j(l)),C=!1,l="",h=0),l+=B,h+=w}}else l.length>0&&(c.push(j(l)),l="",h=0),c.push(j(k)),C=!1,l="",h=0;else p+h>m&&(C=!1,c.push(j(l)),l="",h=0),(l.length>0||!H(k)||C)&&(l+=k,h+=p)}const x=j(l);return x.length>0&&c.push(x),c.join(`
`)}const St={willReadFrequently:!0},$=class f{static get experimentalLetterSpacingSupported(){let t=f._experimentalLetterSpacingSupported;if(t===void 0){const e=it.get().getCanvasRenderingContext2D().prototype;t=f._experimentalLetterSpacingSupported="letterSpacing"in e||"textLetterSpacing"in e}return t}constructor(t,e,i,s,n,o,a,h,l,c){this.text=t,this.style=e,this.width=i,this.height=s,this.lines=n,this.lineWidths=o,this.lineHeight=a,this.maxLineWidth=h,this.fontProperties=l,c&&(this.runsByLine=c.runsByLine,this.lineAscents=c.lineAscents,this.lineDescents=c.lineDescents,this.lineHeights=c.lineHeights,this.hasDropShadow=c.hasDropShadow)}static measureText(t=" ",e,i=f._canvas,s=e.wordWrap){var k;const n=`${t}-${e.styleKey}-wordWrap-${s}`;if(f._measurementCache.has(n))return f._measurementCache.get(n);if(Wt(e)&&kt(t)){const p=Dt(t,e,s,f._context,f._measureText,f.measureFont,f.canBreakChars,f.wordWrapSplit),_=new f(t,e,p.width,p.height,p.lines,p.lineWidths,p.lineHeight,p.maxLineWidth,p.fontProperties,{runsByLine:p.runsByLine,lineAscents:p.lineAscents,lineDescents:p.lineDescents,lineHeights:p.lineHeights,hasDropShadow:p.hasDropShadow});return f._measurementCache.set(n,_),_}const a=e._fontString,h=f.measureFont(a);h.fontSize===0&&(h.fontSize=e.fontSize,h.ascent=e.fontSize,h.descent=0);const l=f._context;l.font=a;const d=(s?f._wordWrap(t,e,i):t).split(Gt),S=new Array(d.length);let y=0;for(let p=0;p<d.length;p++){const _=f._measureText(d[p],e.letterSpacing,l);S[p]=_,y=Math.max(y,_)}const T=((k=e._stroke)==null?void 0:k.width)??0,W=e.lineHeight||h.fontSize,C=f._getAlignWidth(y,e,s),m=f._adjustWidthForStyle(C,e),u=Math.max(W,h.fontSize+T)+(d.length-1)*(W+e.leading),x=f._adjustHeightForStyle(u,e),g=new f(t,e,m,x,d,S,W+e.leading,y,h);return f._measurementCache.set(n,g),g}static _adjustWidthForStyle(t,e){var n;const i=((n=e._stroke)==null?void 0:n.width)||0;let s=t+i;return e.dropShadow&&(s+=e.dropShadow.distance),s}static _adjustHeightForStyle(t,e){let i=t;return e.dropShadow&&(i+=e.dropShadow.distance),i}static _getAlignWidth(t,e,i){return i&&e.align!=="left"&&e.align!=="justify"?Math.max(t,e.wordWrapWidth):t}static _measureText(t,e,i){let s=!1;f.experimentalLetterSpacingSupported&&(f.experimentalLetterSpacing?(i.letterSpacing=`${e}px`,i.textLetterSpacing=`${e}px`,s=!0):(i.letterSpacing="0px",i.textLetterSpacing="0px"));const n=i.measureText(t);let o=n.width;const a=-(n.actualBoundingBoxLeft??0);let l=(n.actualBoundingBoxRight??0)-a;if(o>0)if(s)o-=e,l-=e;else{const c=(f.graphemeSegmenter(t).length-1)*e;o+=c,l+=c}return Math.max(o,l)}static _wordWrap(t,e,i=f._canvas){return Xt(t,e,i,f._measureText,f.canBreakWords,f.canBreakChars,f.wordWrapSplit)}static isBreakingSpace(t,e){return H(t)}static canBreakWords(t,e){return e}static canBreakChars(t,e,i,s,n){return!0}static wordWrapSplit(t){return f.graphemeSegmenter(t)}static measureFont(t){if(f._fonts[t])return f._fonts[t];const e=f._context;e.font=t;const i=e.measureText(f.METRICS_STRING+f.BASELINE_SYMBOL),s=i.actualBoundingBoxAscent??0,n=i.actualBoundingBoxDescent??0,o={ascent:s,descent:n,fontSize:s+n};return f._fonts[t]=o,o}static clearMetrics(t=""){t?delete f._fonts[t]:f._fonts={}}static get _canvas(){if(!f.__canvas){let t;try{const e=new OffscreenCanvas(0,0),i=e.getContext("2d",St);if(i!=null&&i.measureText)return f.__canvas=e,e;t=it.get().createCanvas()}catch{t=it.get().createCanvas()}t.width=t.height=10,f.__canvas=t}return f.__canvas}static get _context(){return f.__context||(f.__context=f._canvas.getContext("2d",St)),f.__context}};$.METRICS_STRING="|ÉqÅ";$.BASELINE_SYMBOL="M";$.BASELINE_MULTIPLIER=1.4;$.HEIGHT_MULTIPLIER=2;$.graphemeSegmenter=(()=>{if(typeof(Intl==null?void 0:Intl.Segmenter)=="function"){const r=new Intl.Segmenter;return t=>{const e=r.segment(t),i=[];let s=0;for(const n of e)i[s++]=n.segment;return i}}return r=>[...r]})();$.experimentalLetterSpacing=!1;$._fonts={};$._measurementCache=yt(1e3);let Q=$;const Ut=["serif","sans-serif","monospace","cursive","fantasy","system-ui"];function nt(r){const t=typeof r.fontSize=="number"?`${r.fontSize}px`:r.fontSize;let e=r.fontFamily;Array.isArray(r.fontFamily)||(e=r.fontFamily.split(","));for(let i=e.length-1;i>=0;i--){let s=e[i].trim();!/([\"\'])[^\'\"]+\1/.test(s)&&!Ut.includes(s)&&(s=`"${s}"`),e[i]=s}return`${r.fontStyle} ${r.fontVariant} ${r.fontWeight} ${t} ${e.join(",")}`}function xt(r,t,e,i=0,s=0,n=0){if(r.texture===q.WHITE&&!r.fill)return X.shared.setValue(r.color).setAlpha(r.alpha??1).toHexa();if(r.fill){if(r.fill instanceof rt){const o=r.fill,a=t.createPattern(o.texture.source.resource,"repeat"),h=o.transform.copyTo(ct.shared);return h.scale(o.texture.source.pixelWidth,o.texture.source.pixelHeight),a.setTransform(h),a}else if(r.fill instanceof tt){const o=r.fill,a=o.type==="linear";o.textureSpace;let h=1,l=1,c;if(a){const{start:d,end:S}=o;c=t.createLinearGradient(d.x*h+s,d.y*l+n,S.x*h+s,S.y*l+n),Math.abs(S.x-d.x)<Math.abs((S.y-d.y)*.1)}else{const{center:d,innerRadius:S,outerCenter:y,outerRadius:T}=o;c=t.createRadialGradient(d.x*h+s,d.y*l+n,S*h,y.x*h+s,y.y*l+n,T*h)}return o.colorStops.forEach(d=>{c.addColorStop(d.offset,X.shared.setValue(d.color).toHex())}),c}}else{const o=t.createPattern(r.texture.source.resource,"repeat"),a=r.matrix.copyTo(ct.shared);return a.scale(r.texture.source.pixelWidth,r.texture.source.pixelHeight),o.setTransform(a),o}return ot("FillStyle not recognised",r),"red"}const ht=class V extends _t{constructor(t={}){super(),this.uid=At("textStyle"),this._tick=0,this._cachedFontString=null,qt(t),t instanceof V&&(t=t._toObject());const s={...V.defaultTextStyle,...t};for(const n in s){const o=n;this[o]=s[n]}this._tagStyles=t.tagStyles??void 0,this.update(),this._tick=0}get align(){return this._align}set align(t){this._align!==t&&(this._align=t,this.update())}get breakWords(){return this._breakWords}set breakWords(t){this._breakWords!==t&&(this._breakWords=t,this.update())}get dropShadow(){return this._dropShadow}set dropShadow(t){this._dropShadow!==t&&(t!==null&&typeof t=="object"?this._dropShadow=this._createProxy({...V.defaultDropShadow,...t}):this._dropShadow=t?this._createProxy({...V.defaultDropShadow}):null,this.update())}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily!==t&&(this._fontFamily=t,this.update())}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize!==t&&(typeof t=="string"?this._fontSize=parseInt(t,10):this._fontSize=t,this.update())}get fontStyle(){return this._fontStyle}set fontStyle(t){this._fontStyle!==t&&(this._fontStyle=t.toLowerCase(),this.update())}get fontVariant(){return this._fontVariant}set fontVariant(t){this._fontVariant!==t&&(this._fontVariant=t,this.update())}get fontWeight(){return this._fontWeight}set fontWeight(t){this._fontWeight!==t&&(this._fontWeight=t,this.update())}get leading(){return this._leading}set leading(t){this._leading!==t&&(this._leading=t,this.update())}get letterSpacing(){return this._letterSpacing}set letterSpacing(t){this._letterSpacing!==t&&(this._letterSpacing=t,this.update())}get lineHeight(){return this._lineHeight}set lineHeight(t){this._lineHeight!==t&&(this._lineHeight=t,this.update())}get padding(){return this._padding}set padding(t){this._padding!==t&&(this._padding=t,this.update())}get filters(){return this._filters}set filters(t){this._filters!==t&&(this._filters=Object.freeze(t),this.update())}get trim(){return this._trim}set trim(t){this._trim!==t&&(this._trim=t,this.update())}get textBaseline(){return this._textBaseline}set textBaseline(t){this._textBaseline!==t&&(this._textBaseline=t,this.update())}get whiteSpace(){return this._whiteSpace}set whiteSpace(t){this._whiteSpace!==t&&(this._whiteSpace=t,this.update())}get wordWrap(){return this._wordWrap}set wordWrap(t){this._wordWrap!==t&&(this._wordWrap=t,this.update())}get wordWrapWidth(){return this._wordWrapWidth}set wordWrapWidth(t){this._wordWrapWidth!==t&&(this._wordWrapWidth=t,this.update())}get fill(){return this._originalFill}set fill(t){t!==this._originalFill&&(this._originalFill=t,this._isFillStyle(t)&&(this._originalFill=this._createProxy({...Y.defaultFillStyle,...t},()=>{this._fill=dt({...this._originalFill},Y.defaultFillStyle)})),this._fill=dt(t===0?"black":t,Y.defaultFillStyle),this.update())}get stroke(){return this._originalStroke}set stroke(t){t!==this._originalStroke&&(this._originalStroke=t,this._isFillStyle(t)&&(this._originalStroke=this._createProxy({...Y.defaultStrokeStyle,...t},()=>{this._stroke=ut({...this._originalStroke},Y.defaultStrokeStyle)})),this._stroke=ut(t,Y.defaultStrokeStyle),this.update())}get tagStyles(){return this._tagStyles}set tagStyles(t){this._tagStyles!==t&&(this._tagStyles=t??void 0,this.update())}update(){this._tick++,this._cachedFontString=null,this.emit("update",this)}reset(){const t=V.defaultTextStyle;for(const e in t)this[e]=t[e]}assign(t){for(const e in t){const i=e;this[i]=t[e]}return this}get styleKey(){return`${this.uid}-${this._tick}`}get _fontString(){return this._cachedFontString===null&&(this._cachedFontString=nt(this)),this._cachedFontString}_toObject(){return{align:this.align,breakWords:this.breakWords,dropShadow:this._dropShadow?{...this._dropShadow}:null,fill:this._fill?{...this._fill}:void 0,fontFamily:this.fontFamily,fontSize:this.fontSize,fontStyle:this.fontStyle,fontVariant:this.fontVariant,fontWeight:this.fontWeight,leading:this.leading,letterSpacing:this.letterSpacing,lineHeight:this.lineHeight,padding:this.padding,stroke:this._stroke?{...this._stroke}:void 0,textBaseline:this.textBaseline,trim:this.trim,whiteSpace:this.whiteSpace,wordWrap:this.wordWrap,wordWrapWidth:this.wordWrapWidth,filters:this._filters?[...this._filters]:void 0,tagStyles:this._tagStyles?{...this._tagStyles}:void 0}}clone(){return new V(this._toObject())}_getFinalPadding(){let t=0;if(this._filters)for(let e=0;e<this._filters.length;e++)t+=this._filters[e].padding;return Math.max(this._padding,t)}destroy(t=!1){var i,s,n,o;if(this.removeAllListeners(),typeof t=="boolean"?t:t==null?void 0:t.texture){const a=typeof t=="boolean"?t:t==null?void 0:t.textureSource;(i=this._fill)!=null&&i.texture&&this._fill.texture.destroy(a),(s=this._originalFill)!=null&&s.texture&&this._originalFill.texture.destroy(a),(n=this._stroke)!=null&&n.texture&&this._stroke.texture.destroy(a),(o=this._originalStroke)!=null&&o.texture&&this._originalStroke.texture.destroy(a)}this._fill=null,this._stroke=null,this.dropShadow=null,this._originalStroke=null,this._originalFill=null}_createProxy(t,e){return new Proxy(t,{set:(i,s,n)=>(i[s]===n||(i[s]=n,e==null||e(s,n),this.update()),!0)})}_isFillStyle(t){return(t??null)!==null&&!(X.isColorLike(t)||t instanceof tt||t instanceof rt)}};ht.defaultDropShadow={alpha:1,angle:Math.PI/6,blur:0,color:"black",distance:5};ht.defaultTextStyle={align:"left",breakWords:!1,dropShadow:null,fill:"black",fontFamily:"Arial",fontSize:26,fontStyle:"normal",fontVariant:"normal",fontWeight:"normal",leading:0,letterSpacing:0,lineHeight:0,padding:0,stroke:null,textBaseline:"alphabetic",trim:!1,whiteSpace:"pre",wordWrap:!1,wordWrapWidth:100};let et=ht;function qt(r){const t=r;if(typeof t.dropShadow=="boolean"&&t.dropShadow){const e=et.defaultDropShadow;r.dropShadow={alpha:t.dropShadowAlpha??e.alpha,angle:t.dropShadowAngle??e.angle,blur:t.dropShadowBlur??e.blur,color:t.dropShadowColor??e.color,distance:t.dropShadowDistance??e.distance}}if(t.strokeThickness!==void 0){N(G,"strokeThickness is now a part of stroke");const e=t.stroke;let i={};if(X.isColorLike(e))i.color=e;else if(e instanceof tt||e instanceof rt)i.fill=e;else if(Object.hasOwnProperty.call(e,"color")||Object.hasOwnProperty.call(e,"fill"))i=e;else throw new Error("Invalid stroke value.");r.stroke={...i,width:t.strokeThickness}}if(Array.isArray(t.fillGradientStops)){if(N(G,"gradient fill is now a fill pattern: `new FillGradient(...)`"),!Array.isArray(t.fill)||t.fill.length===0)throw new Error("Invalid fill value. Expected an array of colors for gradient fill.");t.fill.length!==t.fillGradientStops.length&&ot("The number of fill colors must match the number of fill gradient stops.");const e=new tt({start:{x:0,y:0},end:{x:0,y:1},textureSpace:"local"}),i=t.fillGradientStops.slice(),s=t.fill.map(n=>X.shared.setValue(n).toNumber());i.forEach((n,o)=>{e.addColorStop(n,s[o])}),r.fill={fill:e}}}class bt extends _t{constructor(){super(...arguments),this.chars=Object.create(null),this.lineHeight=0,this.fontFamily="",this.fontMetrics={fontSize:0,ascent:0,descent:0},this.baseLineOffset=0,this.distanceField={type:"none",range:0},this.pages=[],this.applyFillAsTint=!0,this.baseMeasurementFontSize=100,this.baseRenderedFontSize=100}get font(){return N(G,"BitmapFont.font is deprecated, please use BitmapFont.fontFamily instead."),this.fontFamily}get pageTextures(){return N(G,"BitmapFont.pageTextures is deprecated, please use BitmapFont.pages instead."),this.pages}get size(){return N(G,"BitmapFont.size is deprecated, please use BitmapFont.fontMetrics.fontSize instead."),this.fontMetrics.fontSize}get distanceFieldRange(){return N(G,"BitmapFont.distanceFieldRange is deprecated, please use BitmapFont.distanceField.range instead."),this.distanceField.range}get distanceFieldType(){return N(G,"BitmapFont.distanceFieldType is deprecated, please use BitmapFont.distanceField.type instead."),this.distanceField.type}destroy(t=!1){var e;this.emit("destroy",this),this.removeAllListeners();for(const i in this.chars)(e=this.chars[i].texture)==null||e.destroy();this.chars=null,t&&(this.pages.forEach(i=>i.texture.destroy(!0)),this.pages=null)}}const zt=class Lt extends bt{constructor(t){super(),this.resolution=1,this.pages=[],this._padding=0,this._measureCache=Object.create(null),this._currentChars=[],this._currentX=0,this._currentY=0,this._currentMaxCharHeight=0,this._currentPageIndex=-1,this._skipKerning=!1;const e={...Lt.defaultOptions,...t};this._textureSize=e.textureSize,this._mipmap=e.mipmap;const i=e.style.clone();e.overrideFill&&(i._fill.color=16777215,i._fill.alpha=1,i._fill.texture=q.WHITE,i._fill.fill=null),this.applyFillAsTint=e.overrideFill;const s=i.fontSize;i.fontSize=this.baseMeasurementFontSize;const n=nt(i);e.overrideSize?i._stroke&&(i._stroke.width*=this.baseRenderedFontSize/s):i.fontSize=this.baseRenderedFontSize=s,this._style=i,this._skipKerning=e.skipKerning??!1,this.resolution=e.resolution??1,this._padding=e.padding??4,e.textureStyle&&(this._textureStyle=e.textureStyle instanceof ft?e.textureStyle:new ft(e.textureStyle)),this.fontMetrics=Q.measureFont(n),this.lineHeight=i.lineHeight||this.fontMetrics.fontSize||i.fontSize}ensureCharacters(t){var C,m;const e=Q.graphemeSegmenter(t).filter(u=>!this._currentChars.includes(u)).filter((u,x,g)=>g.indexOf(u)===x);if(!e.length)return;this._currentChars=[...this._currentChars,...e];let i;this._currentPageIndex===-1?i=this._nextPage():i=this.pages[this._currentPageIndex];let{canvas:s,context:n}=i.canvasAndContext,o=i.texture.source;const a=this._style;let h=this._currentX,l=this._currentY,c=this._currentMaxCharHeight;const d=this.baseRenderedFontSize/this.baseMeasurementFontSize,S=this._padding*d;let y=!1;const T=s.width/this.resolution,W=s.height/this.resolution;for(let u=0;u<e.length;u++){const x=e[u],g=Q.measureText(x,a,s,!1);g.lineHeight=g.height;const k=g.width*d,p=Math.ceil((a.fontStyle==="italic"?2:1)*k),_=g.height*d,B=p+S*2,w=_+S*2;if(y=!1,x!==`
`&&x!=="\r"&&x!=="	"&&x!==" "&&(y=!0,c=Math.ceil(Math.max(w,c))),h+B>T&&(l+=c,c=w,h=0,l+c>W)){o.update();const v=this._nextPage();s=v.canvasAndContext.canvas,n=v.canvasAndContext.context,o=v.texture.source,h=0,l=0,c=0}const O=k/d-(((C=a.dropShadow)==null?void 0:C.distance)??0)-(((m=a._stroke)==null?void 0:m.width)??0);if(this.chars[x]={id:x.codePointAt(0),xOffset:-this._padding,yOffset:-this._padding,xAdvance:O,kerning:{}},y){this._drawGlyph(n,g,h+S,l+S,d,a);const v=o.width*d,F=o.height*d,z=new st(h/v*o.width,l/F*o.height,B/v*o.width,w/F*o.height);this.chars[x].texture=new q({source:o,frame:z}),h+=Math.ceil(B)}}o.update(),this._currentX=h,this._currentY=l,this._currentMaxCharHeight=c,this._skipKerning&&this._applyKerning(e,n)}get pageTextures(){return N(G,"BitmapFont.pageTextures is deprecated, please use BitmapFont.pages instead."),this.pages}_applyKerning(t,e){const i=this._measureCache;for(let s=0;s<t.length;s++){const n=t[s];for(let o=0;o<this._currentChars.length;o++){const a=this._currentChars[o];let h=i[n];h||(h=i[n]=e.measureText(n).width);let l=i[a];l||(l=i[a]=e.measureText(a).width);let c=e.measureText(n+a).width,d=c-(h+l);d&&(this.chars[n].kerning[a]=d),c=e.measureText(n+a).width,d=c-(h+l),d&&(this.chars[a].kerning[n]=d)}}}_nextPage(){this._currentPageIndex++;const t=this.resolution,e=pt.getOptimalCanvasAndContext(this._textureSize,this._textureSize,t);this._setupContext(e.context,this._style,t);const i=t*(this.baseRenderedFontSize/this.baseMeasurementFontSize),s=new q({source:new vt({resource:e.canvas,resolution:i,alphaMode:"premultiply-alpha-on-upload",autoGenerateMipmaps:this._mipmap})});this._textureStyle&&(s.source.style=this._textureStyle);const n={canvasAndContext:e,texture:s};return this.pages[this._currentPageIndex]=n,n}_setupContext(t,e,i){e.fontSize=this.baseRenderedFontSize,t.scale(i,i),t.font=nt(e),e.fontSize=this.baseMeasurementFontSize,t.textBaseline=e.textBaseline;const s=e._stroke,n=(s==null?void 0:s.width)??0;if(s&&(t.lineWidth=n,t.lineJoin=s.join,t.miterLimit=s.miterLimit,t.strokeStyle=xt(s,t)),e._fill&&(t.fillStyle=xt(e._fill,t)),e.dropShadow){const o=e.dropShadow,a=X.shared.setValue(o.color).toArray(),h=o.blur*i,l=o.distance*i;t.shadowColor=`rgba(${a[0]*255},${a[1]*255},${a[2]*255},${o.alpha})`,t.shadowBlur=h,t.shadowOffsetX=Math.cos(o.angle)*l,t.shadowOffsetY=Math.sin(o.angle)*l}else t.shadowColor="black",t.shadowBlur=0,t.shadowOffsetX=0,t.shadowOffsetY=0}_drawGlyph(t,e,i,s,n,o){const a=e.text,h=e.fontProperties,l=o._stroke,c=((l==null?void 0:l.width)??0)*n,d=i+c/2,S=s-c/2,y=h.descent*n,T=e.lineHeight*n;let W=!1;o.stroke&&c&&(W=!0,t.strokeText(a,d,S+T-y));const{shadowBlur:C,shadowOffsetX:m,shadowOffsetY:u}=t;o._fill&&(W&&(t.shadowBlur=0,t.shadowOffsetX=0,t.shadowOffsetY=0),t.fillText(a,d,S+T-y)),W&&(t.shadowBlur=C,t.shadowOffsetX=m,t.shadowOffsetY=u)}destroy(){super.destroy();for(let t=0;t<this.pages.length;t++){const{canvasAndContext:e,texture:i}=this.pages[t];pt.returnCanvasAndContext(e),i.destroy(!0)}this.pages=null}};zt.defaultOptions={textureSize:512,style:new et,mipmap:!0};let mt=zt;function Jt(r,t,e,i){const s={width:0,height:0,offsetY:0,scale:t.fontSize/e.baseMeasurementFontSize,lines:[{width:0,charPositions:[],spaceWidth:0,spacesIndex:[],chars:[]}]};s.offsetY=e.baseLineOffset;let n=s.lines[0],o=null,a=!0;const h={width:0,start:0,index:0,positions:[],chars:[]},l=e.baseMeasurementFontSize/t.fontSize,c=t.letterSpacing*l,d=t.wordWrapWidth*l,S=t.lineHeight?t.lineHeight*l:e.lineHeight,y=t.wordWrap&&t.breakWords,T=m=>{const u=n.width;for(let x=0;x<h.index;x++){const g=m.positions[x];n.chars.push(m.chars[x]),n.charPositions.push(g+u)}n.width+=m.width,a=!1,h.width=0,h.index=0,h.chars.length=0},W=()=>{let m=n.chars.length-1;if(i){let u=n.chars[m];for(;u===" ";)n.width-=e.chars[u].xAdvance,u=n.chars[--m]}s.width=Math.max(s.width,n.width),n={width:0,charPositions:[],chars:[],spaceWidth:0,spacesIndex:[]},a=!0,s.lines.push(n),s.height+=S},C=m=>m-c>d;for(let m=0;m<r.length+1;m++){let u;const x=m===r.length;x||(u=r[m]);const g=e.chars[u]||e.chars[" "];if(/(?:\s)/.test(u)||u==="\r"||u===`
`||x){if(!a&&t.wordWrap&&C(n.width+h.width)?(W(),T(h),x||n.charPositions.push(0)):(h.start=n.width,T(h),x||n.charPositions.push(0)),u==="\r"||u===`
`)W();else if(!x){const B=g.xAdvance+(g.kerning[o]||0)+c;n.width+=B,n.spaceWidth=B,n.spacesIndex.push(n.charPositions.length),n.chars.push(u)}}else{const _=g.kerning[o]||0,B=g.xAdvance+_+c;y&&C(n.width+h.width+B)&&(T(h),W()),h.positions[h.index++]=h.width+_,h.chars.push(u),h.width+=B}o=u}return W(),t.align==="center"?Zt(s):t.align==="right"?Qt(s):t.align==="justify"&&te(s),s}function Zt(r){for(let t=0;t<r.lines.length;t++){const e=r.lines[t],i=r.width/2-e.width/2;for(let s=0;s<e.charPositions.length;s++)e.charPositions[s]+=i}}function Qt(r){for(let t=0;t<r.lines.length;t++){const e=r.lines[t],i=r.width-e.width;for(let s=0;s<e.charPositions.length;s++)e.charPositions[s]+=i}}function te(r){const t=r.width;for(let e=0;e<r.lines.length;e++){const i=r.lines[e];let s=0,n=i.spacesIndex[s++],o=0;const a=i.spacesIndex.length,l=(t-i.width)/a;for(let c=0;c<i.charPositions.length;c++)c===n&&(n=i.spacesIndex[s++],o+=l),i.charPositions[c]+=o}}function ee(r){if(r==="")return[];typeof r=="string"&&(r=[r]);const t=[];for(let e=0,i=r.length;e<i;e++){const s=r[e];if(Array.isArray(s)){if(s.length!==2)throw new Error(`[BitmapFont]: Invalid character range length, expecting 2 got ${s.length}.`);if(s[0].length===0||s[1].length===0)throw new Error("[BitmapFont]: Invalid character delimiter.");const n=s[0].charCodeAt(0),o=s[1].charCodeAt(0);if(o<n)throw new Error("[BitmapFont]: Invalid character range.");for(let a=n,h=o;a<=h;a++)t.push(String.fromCharCode(a))}else t.push(...Array.from(s))}if(t.length===0)throw new Error("[BitmapFont]: Empty set when resolving characters.");return t}let Z=0;class ie{constructor(){this.ALPHA=[["a","z"],["A","Z"]," "],this.NUMERIC=[["0","9"]],this.ALPHANUMERIC=[["a","z"],["A","Z"],["0","9"]," "],this.ASCII=[[" ","~"]],this.defaultOptions={chars:this.ALPHANUMERIC,resolution:1,padding:4,skipKerning:!1,textureStyle:null},this.measureCache=yt(1e3)}getFont(t,e){var o;let i=`${e.fontFamily}-bitmap`,s=!0;if(e._fill.fill&&!e._stroke?(i+=e._fill.fill.styleKey,s=!1):(e._stroke||e.dropShadow)&&(i=`${e.styleKey}-bitmap`,s=!1),!K.has(i)){const a=Object.create(e);a._lineHeight=0;const h=new mt({style:a,overrideFill:s,overrideSize:!0,...this.defaultOptions});Z++,Z>50&&ot("BitmapText",`You have dynamically created ${Z} bitmap fonts, this can be inefficient. Try pre installing your font styles using \`BitmapFont.install({name:"style1", style})\``),h.once("destroy",()=>{Z--,K.remove(i)}),K.set(i,h)}const n=K.get(i);return(o=n.ensureCharacters)==null||o.call(n,t),n}getLayout(t,e,i=!0){const s=this.getFont(t,e),n=`${t}-${e.styleKey}-${i}`;if(this.measureCache.has(n))return this.measureCache.get(n);const o=Q.graphemeSegmenter(t),a=Jt(o,e,s,i);return this.measureCache.set(n,a),a}measureText(t,e,i=!0){return this.getLayout(t,e,i)}install(...t){var l,c,d,S;let e=t[0];typeof e=="string"&&(e={name:e,style:t[1],chars:(l=t[2])==null?void 0:l.chars,resolution:(c=t[2])==null?void 0:c.resolution,padding:(d=t[2])==null?void 0:d.padding,skipKerning:(S=t[2])==null?void 0:S.skipKerning},N(G,"BitmapFontManager.install(name, style, options) is deprecated, use BitmapFontManager.install({name, style, ...options})"));const i=e==null?void 0:e.name;if(!i)throw new Error("[BitmapFontManager] Property `name` is required.");e={...this.defaultOptions,...e};const s=e.style,n=s instanceof et?s:new et(s),o=e.dynamicFill??this._canUseTintForStyle(n),a=new mt({style:n,overrideFill:o,skipKerning:e.skipKerning,padding:e.padding,resolution:e.resolution,overrideSize:!1,textureStyle:e.textureStyle}),h=ee(e.chars);return a.ensureCharacters(h.join("")),K.set(`${i}-bitmap`,a),a.once("destroy",()=>K.remove(`${i}-bitmap`)),a}uninstall(t){const e=`${t}-bitmap`,i=K.get(e);i&&i.destroy()}_canUseTintForStyle(t){return!t._stroke&&(!t.dropShadow||t.dropShadow.color===0)&&!t._fill.fill&&t._fill.color===16777215}}const wt=new ie;class ae extends bt{constructor(t,e){super();const{textures:i,data:s}=t;Object.keys(s.pages).forEach(n=>{const o=s.pages[parseInt(n,10)],a=i[o.id];this.pages.push({texture:a})}),Object.keys(s.chars).forEach(n=>{const o=s.chars[n],{frame:a,source:h,rotate:l}=i[o.page],c=Mt.transformRectCoords(o,a,l,new st),d=new q({frame:c,orig:new st(0,0,o.width,o.height),source:h,rotate:l});this.chars[n]={id:n.codePointAt(0),xOffset:o.xOffset,yOffset:o.yOffset,xAdvance:o.xAdvance,kerning:o.kerning??{},texture:d}}),this.baseRenderedFontSize=s.fontSize,this.baseMeasurementFontSize=s.fontSize,this.fontMetrics={ascent:0,descent:0,fontSize:s.fontSize},this.baseLineOffset=s.baseLineOffset,this.lineHeight=s.lineHeight,this.fontFamily=s.fontFamily,this.distanceField=s.distanceField??{type:"none",range:0},this.url=e}destroy(){super.destroy();for(let t=0;t<this.pages.length;t++){const{texture:e}=this.pages[t];e.destroy(!0)}this.pages=null}static install(t){wt.install(t)}static uninstall(t){wt.uninstall(t)}}export{ae as BitmapFont};
