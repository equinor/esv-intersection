import{h as E,C as F}from"./elements-b29949ec.js";const y=4,b=2;function v(o){const[t]=o.domain();return Math.abs(o(t+1))}function x(o,t,n,i){return E(v(i)*o,t,n)}function S(o,t,n=y,i=b){const e=o.x+o.width+n,s=t.x+t.width+n,r=o.y+o.height+i,l=t.y+t.height+i;return!(t.x-n>e||t.y-i>r||s+n<o.x||l+i<o.y)}function g(o,t,n=y,i=b){const e=o.x+o.width,s=t.x+t.width,r=o.y+o.height,l=t.y+t.height;if(t.x-n>e||t.y-i>r||s+n<o.x||l+i<o.y)return null;const c=o.x+o.width-t.x+n,a=o.y+o.height-t.y+i;return{dx:c,dy:a}}const k=7,P=11,w=7,B=20,U=120,A=19,u={topleft:"topleft",topright:"topright",bottomleft:"bottomleft",bottomright:"bottomright"};class D extends F{constructor(t,n){super(t,n),this.groupFilter=null,this.renderAnnotation=(i,e,s,r,l,c)=>{this.renderText(i,s,r-l,l,c,"arial","bold"),this.renderText(e,s,r,l,c)},this.renderLine=(i,e,s,r,l,c,a=!0)=>{const{ctx:f}=this,h=a?i:i+s,d=a?i+s:i,m=e+2;f.strokeStyle=c,f.lineWidth=1,f.beginPath(),f.moveTo(r,l),f.lineTo(h,m),f.lineTo(d,m),f.stroke()},this.minFontSize=n.minFontSize||k,this.maxFontSize=n.maxFontSize||P,this.fontSizeFactor=n.fontSizeFactor||w,this.offsetMin=n.offsetMin||B,this.offsetMax=n.offsetMax||U,this.offsetFactor=n.offsetFactor||A}setGroupFilter(t){this.groupFilter=t,this.callouts=void 0,this.render()}onUpdate(t){super.onUpdate(t),this.callouts=void 0,this.render()}onRescale(t){super.onRescale(t);const n=this.rescaleEvent&&this.rescaleEvent.xRatio===t.xRatio;this.rescaleEvent=t,this.render(n)}render(t=!1){requestAnimationFrame(()=>{if(this.clearCanvas(),!this.data||!this.rescaleEvent||!this.referenceSystem)return;const{xScale:n,yScale:i,xBounds:e}=this.rescaleEvent,s=x(this.fontSizeFactor,this.minFontSize,this.maxFontSize,n);if(!t||!this.callouts){const{data:r,ctx:l,groupFilter:c}=this,{calculateDisplacementFromBottom:a}=this.referenceSystem.options,f=a?e[0]<e[1]:e[0]>e[1],h=0;l.font=`bold ${s}px arial`;const d=r.filter(T=>!c||c.includes(T.group)),m=x(this.offsetFactor,this.offsetMin,this.offsetMax,n);this.callouts=this.positionCallouts(d,f,n,i,h,s,m)}this.callouts.forEach(r=>{const{pos:l,title:c,color:a}=r,f=n(l.x),h=i(l.y),d={x:f,y:h,width:r.boundingBox.width,height:s,offsetX:r.dx,offsetY:r.dy};this.renderCallout(c,r.label,d,a,r.alignment)})})}renderText(t,n,i,e,s,r="arial",l="normal"){const{ctx:c}=this;c.font=`${l} ${e}px ${r}`,c.fillStyle=s,c.fillText(t,n,i)}renderPoint(t,n,i=3){const{ctx:e}=this;e.beginPath(),e.moveTo(t,n),e.arc(t,n,i,0,Math.PI*2),e.fill()}renderCallout(t,n,i,e,s){const r=this.getPosition(i,s),{x:l,y:c}=r,{height:a,width:f,x:h,y:d}=i,m=s===u.topright||s===u.bottomright;this.renderAnnotation(t,n,l,c,a,e),this.renderPoint(h,d),this.renderLine(l,c,f,h,d,e,m)}getPosition(t,n){const{x:i,y:e,offsetX:s,offsetY:r,width:l}=t;switch(n){case u.topleft:return{x:i-l-s,y:e-r};case u.topright:return{x:i+s,y:e-r};case u.bottomleft:return{x:i-l-s,y:e+r};case u.bottomright:return{x:i+s,y:e+r};default:return{x:i,y:e}}}positionCallouts(t,n,i,e,s,r,l=20){if(t.length===0)return[];const c=n?u.topleft:u.topright,a=t.map(d=>{const m=d.pos?d.pos:this.referenceSystem.project(d.md);return{title:d.title,label:d.label,color:d.color,pos:{x:m[0],y:m[1]},group:d.group,alignment:c,boundingBox:this.getAnnotationBoundingBox(d.title,d.label,m,i,e,r),dx:l,dy:l}}),f=[a[a.length-1]],h=[];return this.chooseTopOrBottomPosition(a,h,f),this.adjustTopPositions(f),this.adjustBottomPositions(h),a}getAnnotationBoundingBox(t,n,i,e,s,r){const{ctx:l}=this,c=e(i[0]),a=s(i[1]),f=l.measureText(n).width,h=l.measureText(t).width,d=Math.max(f,h);return{x:c,y:a,width:d,height:r*2+4}}chooseTopOrBottomPosition(t,n,i){for(let e=t.length-2;e>=0;--e){const s=t[e],r=i[0];S(s.boundingBox,r.boundingBox)?(s.alignment=s.alignment===u.topleft?u.bottomright:u.bottomleft,n.push(s),e>0&&i.unshift(t[--e])):i.unshift(s)}}adjustTopPositions(t){for(let n=t.length-2;n>=0;--n){const i=t[n];for(let e=t.length-1;e>n;--e){const s=t[e],r=g(i.boundingBox,s.boundingBox);r&&(i.dy+=r.dy,i.boundingBox.y-=r.dy)}}}adjustBottomPositions(t){for(let n=t.length-2;n>=0;--n){const i=t[n];for(let e=t.length-1;e>n;--e){const s=t[e],r=g(s.boundingBox,i.boundingBox);r&&(i.dy+=r.dy,i.boundingBox.y+=r.dy)}}}}const p=(o,t)=>({title:o.pickIdentifier||o.identifier,group:t,label:`${o.md} ${o.mdUnit} ${o.depthReferencePoint}`,color:t==="strat-picks"?"#227":"rgba(0,0,0,0.8)",md:o.md});function $(o){return o?o.map(t=>p(t,"ref-picks")):[]}function _(o){return o?o.filter(t=>t.entryPick.md===t.from).map(t=>p(t.entryPick,"strat-picks")):[]}function L(o){return o?o.filter(t=>o.findIndex(n=>Math.abs(n.entryPick.md-t.exitPick.md)<.5)===-1).map(t=>p(t.exitPick,"strat-picks")).filter((t,n,i)=>n===i.findIndex(e=>e.title===t.title&&e.md===t.md)):[]}const j=o=>[...$(o.nonUnitPicks),..._(o.unitPicks),...L(o.unitPicks)].sort((t,n)=>t.md-n.md),M=o=>({unitName:o.identifier,topSurface:o.top,baseSurface:o.base,ageBase:o.baseAge,ageTop:o.topAge,color:{r:o.colorR===null?255:o.colorR,g:o.colorG===null?255:o.colorG,b:o.colorB===null?255:o.colorB},level:o.stratUnitLevel,lithType:o.lithologyType,parent:o.stratUnitParent});function N(o,t,n){if(n.length===0)return[[o,t]];const i=[];let e=o,s=0;for(;e<t&&s<n.length;){const r=n[s];r.from>e&&i.push([e,Math.min(r.from,t)]),e=Math.min(t,Math.max(o,r.to)),s+=1}return e<t&&i.push([e,t]),i}const C=o=>o.map(M);function I(o,t){const n=C(t),i=[],e=[];return o.forEach(s=>{const r=n.filter(l=>s.pickIdentifier.search(new RegExp(`(${l.topSurface}|${l.baseSurface})`,"i"))!==-1);r.length>0?r.forEach(l=>e.push({md:s.md,tvd:s.tvd,identifier:s.pickIdentifier,confidence:s.confidence,mdUnit:s.mdUnit,depthReferencePoint:s.depthReferencePoint,...l})):i.push({identifier:s.pickIdentifier,...s})}),{joined:e,nonUnitPicks:i}}function O(o){const t=[];let n=null;const i=o.filter(e=>e.level).sort((e,s)=>e.unitName.localeCompare(s.unitName)||e.md-s.md||e.ageTop-s.ageTop);for(;i.length>0;){n=i.shift();const e=n.identifier;let s;const r=e===n.topSurface,l=e===n.baseSurface;if(r)s=n.baseSurface;else if(l)s=n.topSurface;else{console.warn(`Unable to match ${e} with top or base surface, ignored`);continue}let c,a;const f=i.find(h=>h.identifier===s);if(f)c=r?n:f,a=r?f:n,c.md>a.md&&([c,a]=[a,c]),i.splice(i.indexOf(f),1);else if(console.warn(`Unable to find ${s} pick for ${e}`),r)if(c=n,a=o.filter(h=>h.level).sort((h,d)=>h.md-d.md).find(h=>h.md>c.md),a)console.warn(`Using ${a.identifier} as base for ${e}`);else{console.warn(`Unable to find a base pick for ${e} pick at ${c.md}, ignored`);continue}else if(l)if(a=n,c=o.filter(h=>h.level).sort((h,d)=>d.md-h.md).find(h=>h.md<a.md),c)console.warn(`Using ${c.identifier} as top for ${e}`);else{console.warn(`Unable to find a top pick for ${e} pick at ${a.md}, ignored`);continue}else{console.warn(`${e} ignored`);continue}t.push({name:c.unitName,mdEntry:c.md,tvdEntry:c.tvd,color:c.color,level:c.level,entryPick:c,mdExit:a.md,tvdExit:a.tvd,exitPick:a,confidenceEntry:c.confidence,confidenceExit:a.confidence})}return t}function X(o,t){const{joined:n,nonUnitPicks:i}=I(o,t),s=O(n).filter(l=>l.mdEntry<l.mdExit).sort((l,c)=>l.mdEntry-c.mdEntry||l.level-c.level).reverse(),r=[];for(;s.length>0;){const l=s.pop(),c=[];for(;s.length>0&&s[s.length-1].level>l.level;)c.push(s.pop());c.reverse(),c.push(l);const a=[];c.forEach(f=>{const h=N(f.mdEntry,f.mdExit,a);a.push(...h.map(d=>({from:d[0],to:d[1],itm:f})))}),a.sort((f,h)=>f.from-h.from),r.push(...a.map(f=>({from:f.from,to:f.to,...f.itm})))}return{unitPicks:r,nonUnitPicks:i}}export{D as C,x as c,j as g,X as t};
//# sourceMappingURL=picks-d1a7515c.js.map
