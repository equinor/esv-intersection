{"version":3,"file":"PixiLayer.a52855e3.js","sources":["../../../../src/layers/base/PixiLayer.ts"],"sourcesContent":["import { AbstractRenderer, Application, autoDetectRenderer, Container, DisplayObject, IRendererOptionsAuto, Renderer, RENDERER_TYPE } from 'pixi.js';\nimport { Layer, LayerOptions } from './Layer';\nimport { OnMountEvent, OnRescaleEvent, OnResizeEvent, OnUnmountEvent } from '../../interfaces';\nimport { DEFAULT_LAYER_HEIGHT, DEFAULT_LAYER_WIDTH } from '../../constants';\n\n// PixiRenderApplication has many similarities with PIXI.Application,\n// but an important distinction is that it does not run the TickerPlugin.\n// We only want to re-render on data changes\n// The plugin we are trying to avoid:\n// https://github.com/pixijs/pixijs/blob/dev/packages/ticker/src/TickerPlugin.ts\nexport class PixiRenderApplication {\n  stage: Container;\n\n  renderer: AbstractRenderer;\n\n  constructor(pixiRenderOptions?: IRendererOptionsAuto) {\n    const options = {\n      width: DEFAULT_LAYER_WIDTH,\n      height: DEFAULT_LAYER_HEIGHT,\n      antialias: true,\n      backgroundAlpha: 0,\n      clearBeforeRender: true,\n      // autoResize: true,\n      preserveDrawingBuffer: true,\n      ...pixiRenderOptions,\n    };\n    this.renderer = autoDetectRenderer(options);\n    this.stage = new Container();\n  }\n\n  destroy() {\n    this.stage.destroy({\n      children: true,\n      texture: true,\n      baseTexture: true,\n    });\n    this.stage = null;\n\n    // Get renderType and clContext before we destroy the renderer\n    const renderType = this.renderer.type;\n    const glContext = this.renderer instanceof Renderer ? this.renderer?.gl : undefined;\n\n    /**\n     * WebGL v2 does supposedly not have WEBGL_lose_context\n     * so Pixi.js does not use it to \"clean up\" on v2.\n     *\n     * Cleaning up our self since it still seems to work and fix issue with lingering context\n     */\n    if (renderType === RENDERER_TYPE.WEBGL && glContext) {\n      glContext?.getExtension('WEBGL_lose_context')?.loseContext();\n    }\n\n    this.renderer.destroy(true);\n    this.renderer = null;\n  }\n\n  get view() {\n    return this.renderer.view;\n  }\n\n  render() {\n    this.renderer.render(this.stage);\n  }\n}\n\nexport abstract class PixiLayer<T> extends Layer<T> {\n  private pixiViewContainer: HTMLElement;\n  private ctx: PixiRenderApplication;\n  private container: Container;\n\n  constructor(ctx: Application | PixiRenderApplication, id?: string, options?: LayerOptions<T>) {\n    super(id, options);\n\n    this.ctx = ctx;\n\n    this.container = new Container();\n    this.ctx.stage.addChild(this.container);\n  }\n\n  render(): void {\n    this.ctx.render();\n  }\n\n  addChild(child: DisplayObject) {\n    this.container.addChild(child);\n  }\n\n  clearLayer() {\n    const children = this.container.removeChildren();\n    children.forEach((child) => {\n      child.destroy();\n    });\n  }\n\n  onMount(event: OnMountEvent) {\n    super.onMount(event);\n\n    this.pixiViewContainer = this.element.querySelector('#webgl-layer');\n\n    if (!this.pixiViewContainer) {\n      this.pixiViewContainer = document.createElement('div');\n      this.pixiViewContainer.setAttribute('id', `${this.id}`);\n      this.pixiViewContainer.setAttribute('class', 'webgl-layer');\n\n      this.pixiViewContainer.appendChild(this.ctx.view);\n\n      this.element.appendChild(this.pixiViewContainer);\n\n      this.updateStyle();\n    }\n  }\n\n  onUnmount(event?: OnUnmountEvent) {\n    super.onUnmount(event);\n\n    this.clearLayer();\n    this.ctx.stage.removeChild(this.container);\n    this.container.destroy();\n    this.pixiViewContainer.remove();\n    this.pixiViewContainer = undefined;\n  }\n\n  onResize(event: OnResizeEvent): void {\n    super.onResize(event);\n    this.ctx.renderer.resize(event.width, event.height);\n  }\n\n  onRescale(event: OnRescaleEvent): void {\n    super.onRescale(event);\n\n    const flippedX = event.xBounds[0] > event.xBounds[1];\n    const flippedY = event.yBounds[0] > event.yBounds[1];\n    this.setContainerPosition(event.xScale(0), event.yScale(0));\n    this.setContainerScale(event.xRatio * (flippedX ? -1 : 1), event.yRatio * (flippedY ? -1 : 1));\n  }\n\n  protected setContainerPosition(x?: number, y?: number) {\n    this.container.position.set(x, y);\n  }\n\n  protected setContainerScale(x?: number, y?: number) {\n    this.container.scale.set(x, y);\n  }\n\n  updateStyle(visible?: boolean): void {\n    const isVisible = visible || this.isVisible;\n    const interactive = this.interactive ? 'auto' : 'none';\n    this.container.visible = isVisible;\n\n    const styles = [\n      ['position', 'absolute'],\n      ['pointer-events', `${interactive}`],\n      ['z-index', `${this.order}`],\n      ['opacity', `${this.opacity}`],\n    ]\n      .map((pair) => pair.join(':'))\n      .join(';');\n\n    this.pixiViewContainer.setAttribute('style', styles);\n  }\n\n  setVisibility(visible: boolean, layerId?: string): void {\n    super.setVisibility(visible, layerId);\n    if (this.pixiViewContainer) {\n      this.updateStyle(visible);\n    }\n  }\n\n  onOpacityChanged(_opacity: number): void {\n    if (this.pixiViewContainer) {\n      this.updateStyle();\n    }\n  }\n\n  onOrderChanged(_order: number): void {\n    if (this.pixiViewContainer) {\n      this.updateStyle();\n    }\n  }\n\n  onInteractivityChanged(_interactive: boolean): void {\n    if (this.pixiViewContainer) {\n      this.updateStyle();\n    }\n  }\n\n  renderType(): RENDERER_TYPE {\n    return this.ctx.renderer.type;\n  }\n}\n"],"names":["PixiRenderApplication","pixiRenderOptions","__publicField","options","DEFAULT_LAYER_WIDTH","DEFAULT_LAYER_HEIGHT","autoDetectRenderer","Container","renderType","glContext","Renderer","_a","RENDERER_TYPE","_b","PixiLayer","Layer","ctx","id","child","event","flippedX","flippedY","x","y","visible","isVisible","interactive","styles","pair","layerId","_opacity","_order","_interactive"],"mappings":"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"}