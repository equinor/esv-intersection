import{h as j,j as u,n as k,r as Z,t as D,s as w,Z as O,H as F,V as C,u as N}from"./elements-b106df40.js";import{A as B,G as T}from"./GridLayer-9ded7c0c.js";class b{static newton(t,e=.01,r=1e3,s=.5,i=0,n=1){let a=s;for(let h=0;h<r;h++){const c=t(a);if(Math.abs(c)<e)return j(a,i,n);const l=(t(a+1e-4)-c)/1e-4;a=a-c/l}}static bisect(t,e=.01,r=1e3,s=.5,i=0,n=1){let o=i,a=n,h=s,c,l;for(l=0;l<r;l++){if(c=t(h),Math.abs(c)<e)return h;c<0?a=h:o=h,h=(a+o)/2}return h}static findRoot(t,e=.01,r=1e3,s=.5,i=0,n=1){let o=b.newton(t,e,r,s);return o==null&&(o=b.bisect(t,e,r,s,i,n)),o}}class X{static bisect(t,e=0,r=1,s=.005,i=4,n=10){const o=(L,P,v,g,_,x,d=0)=>{const f=(L+P)/2,y=t(f),p=u.distance(v,y),m=u.distance(y,g),z=p+m;if(d>=i&&Math.abs(z-_)<x||d>=n)return z;const S=x/2,I=d+1;return o(L,f,v,y,p,S,I)+o(f,P,y,g,m,S,I)},a=t(e),h=t(r),c=u.distance(a,h);return o(e,r,a,h,c,s)}static trapezoid(t,e=0,r=1,s=1e3){let i=0,n=t(e);const o=(r-e)/(s-1);for(let a=1;a<s;a++){const h=t(e+a*o),c=u.distance(n,h);i+=c,n=h}return i}}class G{static search(t,e){let r=0,s=t.length-1,i=Math.floor(r+s/2);for(;i>r&&i<s;){const n=t[i],o=t[i+1];if(n!=null&&o!=null&&n<=e&&o>=e)return i;n!=null&&e<n?s=i:r=i,i=Math.floor(r+s/2)}return i}}class E extends k{constructor(t,e){super(t,e),this.arcLengthLookup=[],this.findTForArcLength=this.findTForArcLength.bind(this),this.findTByRootForArcLength=this.findTByRootForArcLength.bind(this),this.findApproxTForArcLength=this.findApproxTForArcLength.bind(this),this.findTQuickForArcLength=this.findTQuickForArcLength.bind(this),this.generateArcLengthLookup=this.generateArcLengthLookup.bind(this),this.getArcLength=this.getArcLength.bind(this),this.getQuickArcLength=this.getQuickArcLength.bind(this),this.getPointAtArcLength=this.getPointAtArcLength.bind(this),this.getPointAt=this.getPointAt.bind(this)}findTForArcLength(t,e){let r;return e!=null&&e.approxT?r=this.findApproxTForArcLength(t,e==null?void 0:e.normalizedLength):e!=null&&e.quickT?r=this.findTQuickForArcLength(t):r=this.findTByRootForArcLength(t),r}findTByRootForArcLength(t,e=.01,r=100){return t<=0?0:t>=this.length?1:b.findRoot(i=>t-this.getQuickArcLength(0,i),e,r,t/this.length)}findApproxTForArcLength(t,e){return t/(e||this.length)}findTQuickForArcLength(t){this.arcLengthLookup.length===0&&this.generateArcLengthLookup();const e=G.search(this.arcLengthLookup,t),r=this.arcLengthLookup[e],s=this.arcLengthLookup[e+1];return(e+(t-r)/(s-r))/this.arcLengthLookup.length}generateArcLengthLookup(t=1e3){let e=this.getPointAt(0),r=0;for(let s=0;s<t;s++){const i=this.getPointAt(s/(t-1)),n=u.distance(e,i);r+=n,this.arcLengthLookup.push(r),e=i}}getArcLength(t=0,e=1){if(t===0&&e===1)return this.length;const r=.002;return X.bisect(s=>this.getPointAt(s),t,e,r)}getQuickArcLength(t=0,e=1){let r=0,s=this.length;if(this.arcLengthLookup.length===0&&this.generateArcLengthLookup(),t!==0){const n=Math.floor(t*this.arcLengthLookup.length),o=this.arcLengthLookup[n],a=this.arcLengthLookup[n+1];r=o+t*this.arcLengthLookup.length%this.arcLengthLookup.length*(a-o)}if(e!==1){const n=Math.floor(e*this.arcLengthLookup.length),o=this.arcLengthLookup[n],a=this.arcLengthLookup[n+1];s=o+t*this.arcLengthLookup.length%this.arcLengthLookup.length*(a-o)}return s-r}getPointAtArcLength(t,e){const r=this.findTForArcLength(t,e);return this.getPointAt(r)}getPointAt(t){const e=j(t,0,1);return super.getPointAt(e)}}const H=.75,V=5e3,R=.001,Q=1e3,Y=1e3,U=5e-4,q=.1,$={approxT:!0};class M{constructor(t,e){if(this.path=[],this.projectedPath=[],this._offset=0,t.length<1)throw new Error("Missing coordinates");if(t[0]&&t[0].length!==3)throw new Error("Coordinates should be in 3d");this.setPath(t,e),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.getPosition=this.getPosition.bind(this),this.getProjectedLength=this.getProjectedLength.bind(this),this.getTrajectory=this.getTrajectory.bind(this)}setPath(t,e={}){this.options={...$,...e};const{arcDivisions:r,tension:s,calculateDisplacementFromBottom:i}=this.options;this.path=t,this.projectedPath=M.toDisplacement(t);const[n]=this.projectedPath[this.projectedPath.length-1];this.displacement=n,this.interpolators={curve:e.curveInterpolator||new E(t),trajectory:e.trajectoryInterpolator||new E(t.map(h=>[h[0],h[1]]),{tension:s||H,arcDivisions:r||V}),curtain:e.curtainInterpolator||new E(this.projectedPath,{tension:s||H,arcDivisions:r||V})};const o=this.getTrajectoryVector(),a=o.map(h=>h*-1);i?(this.endVector=a,this.startVector=o):(this.endVector=o,this.startVector=a),this._curtainPathCache=void 0}project(t){const{curtain:e}=this.interpolators,{calculateDisplacementFromBottom:r}=this.options,s=j(r?this.length-(t-this._offset):t-this._offset,0,this.length);return e.getPointAtArcLength(s,this.options)}curtainTangent(t){const{curtain:e}=this.interpolators,r=t-this._offset,s=e.findTForArcLength(r,this.options);return s&&e.getTangentAt(s)}getCurtainPath(t,e,r=!1){if(!this._curtainPathCache){const s=[];let i=Math.PI*2;for(let n=this._offset;n<=this.length+this._offset;n+=q){const o=this.project(n),a=Math.atan2(o[1],o[0]);Math.abs(a-i)>U&&(s.push({point:o,md:n}),i=a)}this._curtainPathCache=s}if(r){const s={point:this.project(t),md:t},i=this._curtainPathCache.filter(o=>o.md>t&&o.md<e),n={point:this.project(e),md:e};return[s,...i,n]}return this._curtainPathCache.filter(s=>s.md>=t&&s.md<=e)}unproject(t){const{normalizedLength:e,calculateDisplacementFromBottom:r}=this.options,s=r?this.displacement-t:t,i=e||this.length;if(s<0)return s;if(s>this.displacement)return i+(s-this.displacement);const n=this.interpolators.curtain.getIntersectsAsPositions(s,0,1);if(n&&n.length)return n[0]*i+this._offset}getProjectedLength(t){const{curtain:e}=this.interpolators,s=this.project(t)[0]/e.maxX;return Number.isFinite(s)?j(s,0,1):0}getPosition(t){const{trajectory:e}=this.interpolators,r=this.getProjectedLength(t);return e.getPointAt(r)}getTrajectory(t,e=0,r=1){const s=e<0?-e:0,i=r>1?r-1:0,n=this.interpolators.trajectory.getPointAt(0),o=this.interpolators.trajectory.getPointAt(1);let a,h,c=0;const l=Math.max(0,e),L=Math.min(1,r),P=this.interpolators.trajectory.getPointAt(l),v=this.interpolators.trajectory.getPointAt(L);s?(a=[n[0]+this.startVector[0]*s*this.displacement,n[1]+this.startVector[1]*s*this.displacement],c=-u.distance(a,n)):e>0&&(c=u.distance(P,n)),i&&(h=[o[0]+this.endVector[0]*i*this.displacement,o[1]+this.endVector[1]*i*this.displacement]);const g=[],_=r-e,x=Math.floor(s/_*t),d=Math.ceil((L-l)/_*t),f=t-d-x;if(a){g.push(a);for(let p=1;p<x;p++){const m=p/x*s*this.displacement;g.push([a[0]-this.startVector[0]*m,a[1]-this.startVector[1]*m])}}const y=this.interpolators.trajectory.getPoints(d-1,null,l,L);if(g.push(...y),h){for(let p=1;p<f-1;p++){const m=p/f*i*this.displacement;g.push([v[0]+this.endVector[0]*m,v[1]+this.endVector[1]*m])}g.push(h)}return{points:g,offset:c}}getExtendedTrajectory(t,e=Q,r=Y){if(!isFinite(e)||e<0)throw new Error("Invalid parameter, getExtendedTrajectory() must be called with a valid and positive startExtensionLength parameter");if(!isFinite(r)||r<0)throw new Error("Invalid parameter, getExtendedTrajectory() must be called with a valid and positive endExtensionLength parameter");const s=this.displacement+e+r,i=Math.floor(e/s*t),n=Math.max(Math.ceil(this.displacement/s*t),1),o=t-n-i,a=[],h=new u(this.interpolators.trajectory.getPointAt(0)),c=new u(this.startVector),l=e/i;for(let d=i;d>0;d--){const f=d*l,y=h.add(c.scale(f));a.push(y.toArray())}const L=this.interpolators.trajectory.getPoints(n,null,0,1);a.push(...L);const P=new u(this.interpolators.trajectory.getPointAt(1)),v=new u(this.endVector),g=r/(o-1);for(let d=1;d<o;d++){const f=d*g,y=P.add(v.scale(f));a.push(y.toArray())}const _=-e;return{points:a,offset:_}}getTrajectoryVector(){const{trajectoryAngle:t,calculateDisplacementFromBottom:e}=this.options;if(t!=null&&isFinite(t)){const s=D(t);return new u(Math.cos(s),Math.sin(s)).toArray()}return M.getDirectionVector(this.interpolators.trajectory,e?R:1-R,e?0:1)}static toDisplacement(t,e=0){let r=t[0],s=0;return t.map(n=>{const o=n[0]-r[0],a=n[1]-r[1];return s+=Math.sqrt(o**2+a**2),r=n,[e>0?e-s:s,n[2]||0]})}static getDirectionVector(t,e,r){const s=t.getPointAt(r),i=t.getPointAt(e);return Z([s[0]-i[0],s[1]-i[1]])}get length(){var t;return((t=this.interpolators.curve)==null?void 0:t.length)??0}get offset(){return this._offset}set offset(t){this._curtainPathCache=void 0,this._offset=t}}class W{constructor(t,e,r){if(this.layers=[],this.createAxis=s=>{const{container:i}=this;this._svgContainer=w(i).append("div").attr("class","axis").style("position","absolute").style("z-index","10").style("pointer-events","none");const n=this._svgContainer.append("svg").attr("height",`${i.offsetHeight}px`).attr("width",`${i.offsetWidth}px`),o=!0;return new B(n,o,s.xLabel,s.yLabel,s.unitOfMeasure)},this.container=t,this.layerContainer=document.createElement("div"),this.layerContainer.className="layer-container",this.container.appendChild(this.layerContainer),this.adjustToSize(+(this.container.getAttribute("width")??0),+(this.container.getAttribute("height")??0)),this._zoomPanHandler=new O(t,s=>this.rescale(s)),e){const{xMin:s,xMax:i,yMin:n,yMax:o,xBounds:a,yBounds:h}=e;s!==void 0&&i!==void 0&&n!==void 0&&o!==void 0&&this._zoomPanHandler.setBounds([s,i],[n,o]),a&&h&&this._zoomPanHandler.setBounds(a,h)}else this._zoomPanHandler.setBounds([0,1],[0,1]);r&&(this._axis=this.createAxis(r)),this.rescale=this.rescale.bind(this)}addLayers(t){return t.forEach(e=>this.addLayer(e)),this}getLayers(){return this.layers}clearAllData(t=!0){return this.layers.forEach(e=>e.clearData(t)),this}addLayer(t,e){return this.layers.push(t),this.initLayer(t,e),this}removeLayer(t){const e=this.layers.find(r=>r.id===t);return e&&(e.onUnmount(),this.layers=this.layers.filter(r=>r.id!==t)),this}removeAllLayers(){const{layers:t}=this;return t.forEach(e=>{this.removeLayer(e.id)}),this}getLayer(t){return this.layers.find(e=>e.id===t||e.getInternalLayerIds().includes(t))}initLayer(t,e){const r={elm:this.layerContainer};t.onMount(r);const s=this.zoomPanHandler.currentStateAsEvent();if(t.onUpdate({...s,...e}),t.onRescale(s),this._svgContainer){const i=this.layers.length>0?this.layers.reduce((n,o)=>n.order>o.order?n:o).order:1;this._svgContainer.style("z-index",`${i+1}`)}return this}showLayer(t){const e=this.getLayer(t);return e?(e.setVisibility(!0,t),e.onRescale(this.zoomPanHandler.currentStateAsEvent()),this):this}hideLayer(t){const e=this.getLayer(t);return e?(e.setVisibility(!1,t),e.onRescale(this.zoomPanHandler.currentStateAsEvent()),this):this}adjustToSize(t,e){const r=Math.max(this._axis?t-F:t,0),s=Math.max(this._axis?e-C:e,0);if(this._axis){const i={width:t,height:e};this._axis.onResize(i)}if(this.layers){const i={width:r,height:s};this.layers.forEach(n=>n.onResize(i))}this._zoomPanHandler&&this._zoomPanHandler.adjustToSize(r,s,!0)}setReferenceSystem(t){this.layers.forEach(e=>e.referenceSystem=t)}showAxis(){var t;return(t=this._axis)==null||t.show(),this}hideAxis(){var t;return(t=this._axis)==null||t.hide(),this}showAxisLabels(){var t;return(t=this._axis)==null||t.showLabels(),this}hideAxisLabels(){var t;return(t=this._axis)==null||t.hideLabels(),this}setAxisOffset(t,e){return this._axis&&(this._axis.offsetX=t,this._axis.offsetY=e,this.layers.filter(s=>s instanceof T).forEach(s=>{s.offsetX=t,s.offsetY=e})),this}setXAxisOffset(t){return this._axis&&(this._axis.offsetX=t,this.layers.filter(r=>r instanceof T).forEach(r=>{r.offsetX=t})),this}setYAxisOffset(t){return this._axis&&(this._axis.offsetY=t,this.layers.filter(r=>r instanceof T).forEach(r=>{r.offsetY=t})),this}setZoomLevelBoundary(t){return this._zoomPanHandler.setZoomLevelBoundary(t),this}setMaxZoomLevel(t){return this._zoomPanHandler.setMaxZoomLevel(t),this}setMinZoomLevel(t){return this._zoomPanHandler.setMinZoomLevel(t),this}destroy(){return this.removeAllLayers(),this.layerContainer.remove(),this._axis=void 0,this._svgContainer=void 0,this}get zoomPanHandler(){return this._zoomPanHandler}get axis(){return this._axis}rescale(t){this._axis&&this._axis.onRescale(t),this.layers&&this.layers.forEach(e=>e.isVisible===!0?e.onRescale(t):{})}}class J{constructor(t,e){this.elements={},this.listeners={},this.enabled=!0;const r=w(e);this.elm=r.append("div").attr("id","overlay").style("z-index","11").style("position","absolute"),this.source=this.elm.node()??void 0;const{elm:s}=this;s.on("resize",i=>{const{width:n,height:o}=i.detail;s.style("width",`${n}px`).style("height",`${o}px`),this.enabled&&Object.keys(this.listeners).forEach(a=>{const h=this.elements[a]??void 0,c=this.listeners[a];c&&c.onResize&&requestAnimationFrame(()=>{var l;return(l=c.onResize)==null?void 0:l.call(c,{target:h,source:this.source,caller:t,width:n,height:o})})})}),s.on("mousemove",i=>{if(!this.enabled)return;const[n,o]=N(i,this.elm.node());Object.keys(this.listeners).forEach(a=>{const h=this.elements[a]??void 0,c=this.listeners[a];c&&c.onMouseMove&&requestAnimationFrame(()=>{var l;return(l=c.onMouseMove)==null?void 0:l.call(c,{x:n,y:o,target:h,source:this.source,caller:t})})})}),s.on("mouseout",()=>{this.enabled&&Object.keys(this.listeners).forEach(i=>{const n=this.elements[i]||void 0,o=this.listeners[i];o&&o.onMouseExit&&requestAnimationFrame(()=>{var a;return(a=o.onMouseExit)==null?void 0:a.call(o,{target:n,source:this.source,caller:t})})})})}create(t,e){const r=this.elm.append("div").style("position","relative").style("pointer-events","none").node();if(r!=null)return this.elements[t]=r,e&&(this.listeners[t]=e),r}register(t,e){this.listeners[t]=e}remove(t){const e=this.elements[t];e&&(w(e).remove(),delete this.elements[t]),delete this.listeners[t]}setZIndex(t){this.elm.style("z-index",t)}destroy(){var t;(t=this.source)==null||t.remove()}}const K=(A,t)=>new J(A,t);class st{constructor(t){const{container:e,axisOptions:r,scaleOptions:s,referenceSystem:i,layers:n,path:o}=t;this._referenceSystem=i||o&&new M(o),this._overlay=K(this,e),this.layerManager=new W(this._overlay.elm.node(),s,r),n&&(this.layerManager.addLayers(n),this.setOverlayZIndex(n))}setReferenceSystem(t){return this._referenceSystem=t,this.layerManager.setReferenceSystem(t),this}updatePath(t,e){return this.setReferenceSystem(new M(t,e)),this}clearAllData(t=!0){return this.layerManager.clearAllData(t),this}addLayer(t,e){return this.layerManager.addLayer(t,e),this.setOverlayZIndex(this.layerManager.getLayers()),this}removeLayer(t){return this.layerManager.removeLayer(t),this}removeAllLayers(){return this.layerManager.removeAllLayers(),this}getLayer(t){return this.layerManager.getLayer(t)}showLayer(t){return this.layerManager.showLayer(t),this}hideLayer(t){return this.layerManager.hideLayer(t),this}adjustToSize(t,e){this.layerManager.adjustToSize(t,e);const r={width:Math.max(t-F,0),height:Math.max(e-C,0)};return this.overlay.elm.dispatch("resize",{detail:r,bubbles:!0,cancelable:!0}),this}setViewport(t,e,r,s){return this.zoomPanHandler.setViewport(t,e,r,s),this}setBounds(t,e){return this.zoomPanHandler.setBounds(t,e),this}showAxis(){return this.layerManager.showAxis(),this}hideAxis(){return this.layerManager.hideAxis(),this}showAxisLabels(){return this.layerManager.showAxisLabels(),this}hideAxisLabels(){return this.layerManager.hideAxisLabels(),this}setAxisOffset(t,e){return this.layerManager.setAxisOffset(t,e),this}setXAxisOffset(t){return this.layerManager.setXAxisOffset(t),this}setYAxisOffset(t){return this.layerManager.setYAxisOffset(t),this}setZoomLevelBoundary(t){return this.zoomPanHandler.setZoomLevelBoundary(t),this}setMaxZoomLevel(t){return this.zoomPanHandler.setMaxZoomLevel(t),this}setMinZoomLevel(t){return this.zoomPanHandler.setMinZoomLevel(t),this}destroy(){return this.layerManager.destroy(),this._overlay.destroy(),this._referenceSystem=void 0,this}getHighestZIndex(t){return t.length>0?t.reduce((r,s)=>r.order>s.order?r:s).order:1}setOverlayZIndex(t){const e=this.getHighestZIndex(t);this.overlay.setZIndex(e+2)}get overlay(){return this._overlay}get referenceSystem(){return this._referenceSystem}get zoomPanHandler(){return this.layerManager.zoomPanHandler}get axis(){return this.layerManager.axis}get currentStateAsEvent(){return this.zoomPanHandler.currentStateAsEvent()}}export{st as C,M as I};
//# sourceMappingURL=MainController-3dc2717f.js.map
