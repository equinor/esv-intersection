var S=Object.defineProperty;var v=(e,s,t)=>s in e?S(e,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[s]=t;var u=(e,s,t)=>(v(e,typeof s!="symbol"?s+"":s,t),t);import{f as k,C as P}from"./elements.b2968f38.js";const F=4,E=2;function w(e){const[s]=e.domain();return Math.abs(e(s+1))}function y(e,s,t,i){return k(w(i)*e,s,t)}function B(e,s,t=F,i=E){const o=e.x+e.width+t,n=s.x+s.width+t,c=e.y+e.height+i,r=s.y+s.height+i;return!(s.x-t>o||s.y-i>c||n+t<e.x||r+i<e.y)}function b(e,s,t=F,i=E){const o=e.x+e.width,n=s.x+s.width,c=e.y+e.height,r=s.y+s.height;if(s.x-t>o||s.y-i>c||n+t<e.x||r+i<e.y)return null;const l=e.x+e.width-s.x+t,a=e.y+e.height-s.y+i;return{dx:l,dy:a}}const U=7,A=11,$=7,_=20,M=120,L=19,p={topleft:"topleft",topright:"topright",bottomleft:"bottomleft",bottomright:"bottomright"};class W extends P{constructor(t,i){super(t,i);u(this,"rescaleEvent");u(this,"xRatio");u(this,"callouts");u(this,"groupFilter",null);u(this,"minFontSize");u(this,"maxFontSize");u(this,"fontSizeFactor");u(this,"offsetMin");u(this,"offsetMax");u(this,"offsetFactor");u(this,"renderAnnotation",(t,i,o,n,c,r)=>{this.renderText(t,o,n-c,c,r,"arial","bold"),this.renderText(i,o,n,c,r)});u(this,"renderLine",(t,i,o,n,c,r,l=!0)=>{const{ctx:a}=this,f=l?t:t+o,d=l?t+o:t,h=i+2;a.strokeStyle=r,a.lineWidth=1,a.beginPath(),a.moveTo(n,c),a.lineTo(f,h),a.lineTo(d,h),a.stroke()});this.minFontSize=i.minFontSize||U,this.maxFontSize=i.maxFontSize||A,this.fontSizeFactor=i.fontSizeFactor||$,this.offsetMin=i.offsetMin||_,this.offsetMax=i.offsetMax||M,this.offsetFactor=i.offsetFactor||L}setGroupFilter(t){this.groupFilter=t,this.callouts=void 0,this.render()}onUpdate(t){super.onUpdate(t),this.callouts=void 0,this.render()}onRescale(t){super.onRescale(t);const i=this.rescaleEvent&&this.rescaleEvent.xRatio===t.xRatio;this.rescaleEvent=t,this.render(i)}render(t=!1){requestAnimationFrame(()=>{if(this.clearCanvas(),!this.data||!this.rescaleEvent||!this.referenceSystem)return;const{xScale:i,yScale:o,xBounds:n}=this.rescaleEvent,c=y(this.fontSizeFactor,this.minFontSize,this.maxFontSize,i);if(!t||!this.callouts){const{data:r,ctx:l,groupFilter:a}=this,{calculateDisplacementFromBottom:f}=this.referenceSystem.options,d=f?n[0]<n[1]:n[0]>n[1],h=0;l.font=`bold ${c}px arial`;const m=r.filter(T=>!a||a.includes(T.group)),x=y(this.offsetFactor,this.offsetMin,this.offsetMax,i);this.callouts=this.positionCallouts(m,d,i,o,h,c,x)}this.callouts.forEach(r=>{const{pos:l,title:a,color:f}=r,d=i(l.x),h=o(l.y),m={x:d,y:h,width:r.boundingBox.width,height:c,offsetX:r.dx,offsetY:r.dy};this.renderCallout(a,r.label,m,f,r.alignment)})})}renderText(t,i,o,n,c,r="arial",l="normal"){const{ctx:a}=this;a.font=`${l} ${n}px ${r}`,a.fillStyle=c,a.fillText(t,i,o)}renderPoint(t,i,o=3){const{ctx:n}=this;n.beginPath(),n.moveTo(t,i),n.arc(t,i,o,0,Math.PI*2),n.fill()}renderCallout(t,i,o,n,c){const r=this.getPosition(o,c),{x:l,y:a}=r,{height:f,width:d,x:h,y:m}=o,x=c===p.topright||c===p.bottomright;this.renderAnnotation(t,i,l,a,f,n),this.renderPoint(h,m),this.renderLine(l,a,d,h,m,n,x)}getPosition(t,i){const{x:o,y:n,offsetX:c,offsetY:r,width:l}=t;switch(i){case p.topleft:return{x:o-l-c,y:n-r};case p.topright:return{x:o+c,y:n-r};case p.bottomleft:return{x:o-l-c,y:n+r};case p.bottomright:return{x:o+c,y:n+r};default:return{x:o,y:n}}}positionCallouts(t,i,o,n,c,r,l=20){if(t.length===0)return[];const a=i?p.topleft:p.topright,f=t.map(m=>{const x=m.pos?m.pos:this.referenceSystem.project(m.md);return{title:m.title,label:m.label,color:m.color,pos:{x:x[0],y:x[1]},group:m.group,alignment:a,boundingBox:this.getAnnotationBoundingBox(m.title,m.label,x,o,n,r),dx:l,dy:l}}),d=[f[f.length-1]],h=[];return this.chooseTopOrBottomPosition(f,h,d),this.adjustTopPositions(d),this.adjustBottomPositions(h),f}getAnnotationBoundingBox(t,i,o,n,c,r){const{ctx:l}=this,a=n(o[0]),f=c(o[1]),d=l.measureText(i).width,h=l.measureText(t).width,m=Math.max(d,h);return{x:a,y:f,width:m,height:r*2+4}}chooseTopOrBottomPosition(t,i,o){for(let n=t.length-2;n>=0;--n){const c=t[n],r=o[0];B(c.boundingBox,r.boundingBox)?(c.alignment=c.alignment===p.topleft?p.bottomright:p.bottomleft,i.push(c),n>0&&o.unshift(t[--n])):o.unshift(c)}}adjustTopPositions(t){for(let i=t.length-2;i>=0;--i){const o=t[i];for(let n=t.length-1;n>i;--n){const c=t[n],r=b(o.boundingBox,c.boundingBox);r&&(o.dy+=r.dy,o.boundingBox.y-=r.dy)}}}adjustBottomPositions(t){for(let i=t.length-2;i>=0;--i){const o=t[i];for(let n=t.length-1;n>i;--n){const c=t[n],r=b(c.boundingBox,o.boundingBox);r&&(o.dy+=r.dy,o.boundingBox.y+=r.dy)}}}}const g=(e,s)=>({title:e.pickIdentifier||e.identifier,group:s,label:`${e.md} ${e.mdUnit} ${e.depthReferencePoint}`,color:s==="strat-picks"?"#227":"rgba(0,0,0,0.8)",md:e.md});function N(e){return e?e.map(s=>g(s,"ref-picks")):[]}function R(e){return e?e.filter(s=>s.entryPick.md===s.from).map(s=>g(s.entryPick,"strat-picks")):[]}function C(e){return e?e.filter(s=>e.findIndex(t=>Math.abs(t.entryPick.md-s.exitPick.md)<.5)===-1).map(s=>g(s.exitPick,"strat-picks")).filter((s,t,i)=>t===i.findIndex(o=>o.title===s.title&&o.md===s.md)):[]}const Y=e=>[...N(e.nonUnitPicks),...R(e.unitPicks),...C(e.unitPicks)].sort((s,t)=>s.md-t.md),I=e=>({unitName:e.identifier,topSurface:e.top,baseSurface:e.base,ageBase:e.baseAge,ageTop:e.topAge,color:{r:e.colorR===null?255:e.colorR,g:e.colorG===null?255:e.colorG,b:e.colorB===null?255:e.colorB},level:e.stratUnitLevel,lithType:e.lithologyType,parent:e.stratUnitParent});function O(e,s,t){if(t.length===0)return[[e,s]];const i=[];let o=e,n=0;for(;o<s&&n<t.length;){const c=t[n];c.from>o&&i.push([o,Math.min(c.from,s)]),o=Math.min(s,Math.max(e,c.to)),n+=1}return o<s&&i.push([o,s]),i}const D=e=>e.map(I);function j(e,s){const t=D(s),i=[],o=[];return e.forEach(n=>{const c=t.filter(r=>n.pickIdentifier.search(new RegExp(`(${r.topSurface}|${r.baseSurface})`,"i"))!==-1);c.length>0?c.forEach(r=>o.push({md:n.md,tvd:n.tvd,identifier:n.pickIdentifier,confidence:n.confidence,mdUnit:n.mdUnit,depthReferencePoint:n.depthReferencePoint,...r})):i.push({identifier:n.pickIdentifier,...n})}),{joined:o,nonUnitPicks:i}}function z(e){const s=[];let t=null;const i=e.filter(o=>o.level).sort((o,n)=>o.unitName.localeCompare(n.unitName)||o.md-n.md||o.ageTop-n.ageTop);for(;i.length>0;){t=i.shift();const o=t.identifier;let n;const c=o===t.topSurface,r=o===t.baseSurface;if(c)n=t.baseSurface;else if(r)n=t.topSurface;else{console.warn(`Unable to match ${o} with top or base surface, ignored`);continue}let l,a;const f=i.find(d=>d.identifier===n);if(f)l=c?t:f,a=c?f:t,l.md>a.md&&([l,a]=[a,l]),i.splice(i.indexOf(f),1);else if(console.warn(`Unable to find ${n} pick for ${o}`),c)if(l=t,a=e.filter(d=>d.level).sort((d,h)=>d.md-h.md).find(d=>d.md>l.md),a)console.warn(`Using ${a.identifier} as base for ${o}`);else{console.warn(`Unable to find a base pick for ${o} pick at ${l.md}, ignored`);continue}else if(r)if(a=t,l=e.filter(d=>d.level).sort((d,h)=>h.md-d.md).find(d=>d.md<a.md),l)console.warn(`Using ${l.identifier} as top for ${o}`);else{console.warn(`Unable to find a top pick for ${o} pick at ${a.md}, ignored`);continue}else{console.warn(`${o} ignored`);continue}s.push({name:l.unitName,mdEntry:l.md,tvdEntry:l.tvd,color:l.color,level:l.level,entryPick:l,mdExit:a.md,tvdExit:a.tvd,exitPick:a,confidenceEntry:l.confidence,confidenceExit:a.confidence})}return s}function Z(e,s){const{joined:t,nonUnitPicks:i}=j(e,s),n=z(t).filter(r=>r.mdEntry<r.mdExit).sort((r,l)=>r.mdEntry-l.mdEntry||r.level-l.level).reverse(),c=[];for(;n.length>0;){const r=n.pop(),l=[];for(;n.length>0&&n[n.length-1].level>r.level;)l.push(n.pop());l.reverse(),l.push(r);const a=[];l.forEach(f=>{const d=O(f.mdEntry,f.mdExit,a);a.push(...d.map(h=>({from:h[0],to:h[1],itm:f})))}),a.sort((f,d)=>f.from-d.from),c.push(...a.map(f=>({from:f.from,to:f.to,...f.itm})))}return{unitPicks:c,nonUnitPicks:i}}export{W as C,y as c,Y as g,Z as t};
//# sourceMappingURL=picks.76e1c011.js.map
