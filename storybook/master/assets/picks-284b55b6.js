import{o as E,C as F}from"./elements-7cf8c049.js";const b=4,T=2;function v(i){const[t]=i.domain();return Math.abs(i(t+1))}function p(i,t,e,o){return E(v(o)*i,t,e)}function S(i,t,e=b,o=T){const n=i.x+i.width+e,s=t.x+t.width+e,r=i.y+i.height+o,l=t.y+t.height+o;return!(t.x-e>n||t.y-o>r||s+e<i.x||l+o<i.y)}function y(i,t,e=b,o=T){const n=i.x+i.width,s=t.x+t.width,r=i.y+i.height,l=t.y+t.height;if(t.x-e>n||t.y-o>r||s+e<i.x||l+o<i.y)return;const c=i.x+i.width-t.x+e,a=i.y+i.height-t.y+o;return{dx:c,dy:a}}const k=7,P=11,w=7,B=20,U=120,A=19,m={topleft:"topleft",topright:"topright",bottomleft:"bottomleft",bottomright:"bottomright"};class D extends F{constructor(t,e){super(t,e),this.callouts=[],this.groupFilter=[],this.renderAnnotation=(o,n,s,r,l,c)=>{this.renderText(o,s,r-l,l,c,"arial","bold"),this.renderText(n,s,r,l,c)},this.renderLine=(o,n,s,r,l,c,a=!0)=>{const{ctx:h}=this,f=a?o:o+s,d=a?o+s:o,u=n+2;h!=null&&(h.strokeStyle=c,h.lineWidth=1,h.beginPath(),h.moveTo(r,l),h.lineTo(f,u),h.lineTo(d,u),h.stroke())},this.minFontSize=(e==null?void 0:e.minFontSize)||k,this.maxFontSize=(e==null?void 0:e.maxFontSize)||P,this.fontSizeFactor=(e==null?void 0:e.fontSizeFactor)||w,this.offsetMin=(e==null?void 0:e.offsetMin)||B,this.offsetMax=(e==null?void 0:e.offsetMax)||U,this.offsetFactor=(e==null?void 0:e.offsetFactor)||A}setGroupFilter(t){this.groupFilter=t,this.callouts=[],this.render()}onUpdate(t){super.onUpdate(t),this.callouts=[],this.render()}onRescale(t){super.onRescale(t);const e=this.rescaleEvent&&this.rescaleEvent.xRatio===t.xRatio;this.rescaleEvent=t,this.render(e)}render(t=!1){requestAnimationFrame(()=>{if(this.clearCanvas(),!this.data||!this.rescaleEvent||!this.referenceSystem)return;const{xScale:e,yScale:o,xBounds:n}=this.rescaleEvent,s=p(this.fontSizeFactor,this.minFontSize,this.maxFontSize,e);if(!t||this.callouts.length<=0){const{data:r,ctx:l,groupFilter:c}=this,{calculateDisplacementFromBottom:a}=this.referenceSystem.options,h=a?n[0]<n[1]:n[0]>n[1],f=0;l!=null&&(l.font=`bold ${s}px arial`);const d=r.filter(g=>c.length<=0||c.includes(g.group)),u=p(this.offsetFactor,this.offsetMin,this.offsetMax,e);this.callouts=this.positionCallouts(d,h,e,o,f,s,u)}this.callouts.forEach(r=>{const{pos:l,title:c,color:a}=r,h=e(l.x),f=o(l.y),d={x:h,y:f,width:r.boundingBox.width,height:s,offsetX:r.dx,offsetY:r.dy};this.renderCallout(c,r.label,d,a,r.alignment)})})}renderText(t,e,o,n,s,r="arial",l="normal"){const{ctx:c}=this;c!=null&&(c.font=`${l} ${n}px ${r}`,c.fillStyle=s,c.fillText(t,e,o))}renderPoint(t,e,o=3){const{ctx:n}=this;n!=null&&(n.beginPath(),n.moveTo(t,e),n.arc(t,e,o,0,Math.PI*2),n.fill())}renderCallout(t,e,o,n,s){const r=this.getPosition(o,s),{x:l,y:c}=r,{height:a,width:h,x:f,y:d}=o,u=s===m.topright||s===m.bottomright;this.renderAnnotation(t,e,l,c,a,n),this.renderPoint(f,d),this.renderLine(l,c,h,f,d,n,u)}getPosition(t,e){const{x:o,y:n,offsetX:s=0,offsetY:r=0,width:l}=t;switch(e){case m.topleft:return{x:o-l-s,y:n-r};case m.topright:return{x:o+s,y:n-r};case m.bottomleft:return{x:o-l-s,y:n+r};case m.bottomright:return{x:o+s,y:n+r};default:return{x:o,y:n}}}positionCallouts(t,e,o,n,s,r,l=20){if(t.length===0)return[];const c=e?m.topleft:m.topright,a=t.map(d=>{var g;const u=d.pos?d.pos:(g=this.referenceSystem)==null?void 0:g.project(d.md);return{title:d.title,label:d.label,color:d.color,pos:{x:u==null?void 0:u[0],y:u==null?void 0:u[1]},group:d.group,alignment:c,boundingBox:this.getAnnotationBoundingBox(d.title,d.label,u,o,n,r),dx:l,dy:l}}),h=[a[a.length-1]],f=[];return this.chooseTopOrBottomPosition(a,f,h),this.adjustTopPositions(h),this.adjustBottomPositions(f),a}getAnnotationBoundingBox(t,e,o,n,s,r){const{ctx:l}=this,c=n(o[0]),a=s(o[1]),h=(l==null?void 0:l.measureText(e).width)??0,f=(l==null?void 0:l.measureText(t).width)??0,d=Math.max(h,f);return{x:c,y:a,width:d,height:r*2+4}}chooseTopOrBottomPosition(t,e,o){for(let n=t.length-2;n>=0;--n){const s=t[n],r=o[0];S(s.boundingBox,r.boundingBox)?(s.alignment=s.alignment===m.topleft?m.bottomright:m.bottomleft,e.push(s),n>0&&o.unshift(t[--n])):o.unshift(s)}}adjustTopPositions(t){for(let e=t.length-2;e>=0;--e){const o=t[e];for(let n=t.length-1;n>e;--n){const s=t[n],r=y(o.boundingBox,s.boundingBox);r&&(o.dy+=r.dy,o.boundingBox.y-=r.dy)}}}adjustBottomPositions(t){for(let e=t.length-2;e>=0;--e){const o=t[e];for(let n=t.length-1;n>e;--n){const s=t[n],r=y(s.boundingBox,o.boundingBox);r&&(o.dy+=r.dy,o.boundingBox.y+=r.dy)}}}}const x=(i,t)=>({title:i.pickIdentifier||i.identifier,group:t,label:`${i.md} ${i.mdUnit} ${i.depthReferencePoint}`,color:t==="strat-picks"?"#227":"rgba(0,0,0,0.8)",md:i.md});function $(i){return i?i.map(t=>x(t,"ref-picks")):[]}function _(i){return i?i.filter(t=>t.entryPick.md===t.from).map(t=>x(t.entryPick,"strat-picks")):[]}function L(i){return i?i.filter(t=>i.findIndex(e=>Math.abs(e.entryPick.md-t.exitPick.md)<.5)===-1).map(t=>x(t.exitPick,"strat-picks")).filter((t,e,o)=>e===o.findIndex(n=>n.title===t.title&&n.md===t.md)):[]}const j=i=>[...$(i.nonUnitPicks),..._(i.unitPicks),...L(i.unitPicks)].sort((t,e)=>t.md-e.md),M=i=>({unitName:i.identifier,topSurface:i.top,baseSurface:i.base,ageBase:i.baseAge,ageTop:i.topAge,color:{r:i.colorR===null?255:i.colorR,g:i.colorG===null?255:i.colorG,b:i.colorB===null?255:i.colorB},level:i.stratUnitLevel,lithType:i.lithologyType,parent:i.stratUnitParent});function N(i,t,e){if(e.length===0)return[[i,t]];const o=[];let n=i,s=0;for(;n<t&&s<e.length;){const r=e[s];r.from>n&&o.push([n,Math.min(r.from,t)]),n=Math.min(t,Math.max(i,r.to)),s+=1}return n<t&&o.push([n,t]),o}const C=i=>i.map(M);function I(i,t){const e=C(t),o=[],n=[];return i.forEach(s=>{const r=e.filter(l=>{var c;return((c=s.pickIdentifier)==null?void 0:c.search(new RegExp(`(${l.topSurface}|${l.baseSurface})`,"i")))!==-1});r.length>0?r.forEach(l=>n.push({md:s.md,tvd:s.tvd,identifier:s.pickIdentifier,confidence:s.confidence,mdUnit:s.mdUnit,depthReferencePoint:s.depthReferencePoint,...l})):o.push({identifier:s.pickIdentifier,...s})}),{joined:n,nonUnitPicks:o}}function O(i){const t=[];let e=null;const o=i.filter(n=>n.level).sort((n,s)=>n.unitName.localeCompare(s.unitName)||n.md-s.md||n.ageTop-s.ageTop);for(;o.length>0;){e=o.shift();const n=e.identifier;let s;const r=n===e.topSurface,l=n===e.baseSurface;if(r)s=e.baseSurface;else if(l)s=e.topSurface;else{console.warn(`Unable to match ${n} with top or base surface, ignored`);continue}let c,a;const h=o.find(f=>f.identifier===s);if(h)c=r?e:h,a=r?h:e,c.md>a.md&&([c,a]=[a,c]),o.splice(o.indexOf(h),1);else if(console.warn(`Unable to find ${s} pick for ${n}`),r)if(c=e,a=i.filter(f=>f.level).sort((f,d)=>f.md-d.md).find(f=>f.md>c.md),a)console.warn(`Using ${a.identifier} as base for ${n}`);else{console.warn(`Unable to find a base pick for ${n} pick at ${c.md}, ignored`);continue}else if(l)if(a=e,c=i.filter(f=>f.level).sort((f,d)=>d.md-f.md).find(f=>f.md<a.md),c)console.warn(`Using ${c.identifier} as top for ${n}`);else{console.warn(`Unable to find a top pick for ${n} pick at ${a.md}, ignored`);continue}else{console.warn(`${n} ignored`);continue}t.push({name:c.unitName,mdEntry:c.md,tvdEntry:c.tvd,color:c.color,level:c.level,entryPick:c,mdExit:a.md,tvdExit:a.tvd,exitPick:a,confidenceEntry:c.confidence,confidenceExit:a.confidence})}return t}function X(i,t){var l;const{joined:e,nonUnitPicks:o}=I(i,t),s=O(e).filter(c=>c.mdEntry<c.mdExit).sort((c,a)=>c.mdEntry-a.mdEntry||c.level-a.level).reverse(),r=[];for(;s.length>0;){const c=s.pop(),a=[];for(;s.length>0&&((l=s[s.length-1])==null?void 0:l.level)>c.level;)a.push(s.pop());a.reverse(),a.push(c);const h=[];a.forEach(f=>{const d=N(f.mdEntry,f.mdExit,h);h.push(...d.map(u=>({from:u[0],to:u[1],itm:f})))}),h.sort((f,d)=>f.from-d.from),r.push(...h.map(f=>({from:f.from,to:f.to,...f.itm})))}return{unitPicks:r,nonUnitPicks:o}}export{D as C,p as c,j as g,X as t};
//# sourceMappingURL=picks-284b55b6.js.map
