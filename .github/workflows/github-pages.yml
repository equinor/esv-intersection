name: Deploy Docs and Storybook

on:
  workflow_dispatch:
  push:
    branches: [ master, latest ]

jobs:
  deploy-docs-n-storybook:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        submodules: true
        persist-credentials: false

    - name: Setup Nodejs
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        cache: 'npm'

    - name: Info
      run: echo "Running on branch $(basename ${{ github.ref }})"

    - name: Install dependencies
      run:  npm ci --prefer-offline

    - name: Create build dir
      run: mkdir docs_out

    - name: Build documentation # only if this was triggered from latest
      if: github.ref == 'refs/heads/latest'
      run: |
        npm run docs
        npm run postdocs

    - name: Generate storybook
      run:  npx build-storybook -c .storybook -o docs_out/storybook/$(basename ${{ github.ref }})

    - name: Publish GH pages
      uses: JamesIves/github-pages-deploy-action@releases/v4
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        BRANCH: gh-pages  # The branch the action should deploy to.
        FOLDER: docs_out  # The folder the action should deploy.
